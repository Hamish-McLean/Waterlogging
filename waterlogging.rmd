---
title: "Waterlogging Analysis"
author: "Hamish McLean"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_packages}

library(data.table)
library(dplyr)
library(ggpubr)
library(here)
library(readxl)

source(here("R", "functions.R"))

```

```{r constants}

here        <- here::here()
data_dir    <- file.path(here, "..", "Data")
figures_dir <- file.path(here, "figures")

```

## Load data

### Experiment 1

```{r load_data_E1}

E1_2023 <- load_data(
  data_dir, "2023 E1 growth measurements.xlsx", 
  c(
    "d_spring", "d_fall", "h_spring", "h_fall", "health_fall",
    "mainstem", "peripheral", "inoc_points", "aborted", "inoc_cankers"
  )
)

# Combine diameter and height measurements
E1_2023[, diameter := coalesce(d_spring, d_fall)]
E1_2023[, height   := coalesce(h_spring, h_fall)]
E1_2023[, c("d_spring", "d_fall", "h_spring", "h_fall") := NULL]

# Rename health_fall to health
E1_2023[, health := health_fall][, health_fall := NULL]

# Calculate total cankers
E1_2023[,
  cankers := rowSums(.SD, na.rm = FALSE),
  .SDcols = c("mainstem", "peripheral")
]

E1_2024_cankers <- load_data(
  data_dir, "2024-09-23 E1 canker assessment.xlsx", 
  c("cankers", "health")
)

E1_2024_growth <- load_data(
  data_dir, "2024-11 E1 growth measurements.xlsx", 
  c("diameter", "height", "health")
)

# Combine E1 tables
E1 <- Reduce(
  function(x, y) {
    # Find common columns to merge on
    common_cols <- intersect(colnames(x), colnames(y))
    # Merge the data.tables on common columns
    merge(x, y, by = common_cols, all = TRUE)
  }, 
  list(E1_2023, E1_2024_cankers, E1_2024_growth)
)

head(E1)



```

### Experiment 2

```{r load_data_E2}



```

```{r plots}

# Summarise data by plot, taking the sum of canker measurements
E1_canker_summary <- E1_2023[, .(
  mainstem = sum(mainstem, na.rm = TRUE),
  peripheral = sum(peripheral, na.rm = TRUE),
  total_cankers = sum(total_cankers, na.rm = TRUE)
), by = .(block, plot, duration)]

E1_canker_summary
# Quick boxplot of total_cankers by treatment

ggboxplot(E1_canker_summary, x = "duration", y = "total_cankers",
  color = "duration", palette = "jco",
  add = "jitter",
  title = "Total Cankers by Treatment",
  xlab = "Treatment", ylab = "Total Cankers"
) + theme(legend.position = "none")

```

