---
title: "Waterlogging Analysis"
author: "Hamish McLean"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_packages}

library(data.table)
library(dplyr)
library(ggpubr)
library(here)
library(readxl)

```

```{r constants}

# Set the working directory to the project root
here::set_here()

# Set data and figures directories
data_dir    <- here("..", "Data")
figures_dir <- here("figures")

# Load custom functions
source(here("functions", "load_data.R"))

```

## Load data

### Experiment 1

```{r load_data_E1}

e1_2023 <- load_data(
  data_dir, "2023 E1 growth measurements.xlsx",
  c(
    "d_spring", "d_fall", "h_spring", "h_fall", "health_fall",
    "mainstem", "peripheral", "inoc_points", "aborted", "inoc_cankers"
  )
)

# Combine diameter and height measurements
e1_2023[, diameter := coalesce(d_spring, d_fall)]
e1_2023[, height   := coalesce(h_spring, h_fall)]
e1_2023[, c("d_spring", "d_fall", "h_spring", "h_fall") := NULL]

# Rename health_fall to health
e1_2023[, health := health_fall][, health_fall := NULL]

# Calculate total cankers
e1_2023[,
  cankers := rowSums(.SD, na.rm = FALSE),
  .SDcols = c("mainstem", "peripheral")
]

e1_2024_cankers <- load_data(
  data_dir, "2024-09-23 E1 canker assessment.xlsx", "cankers"
)

e1_2024_growth <- load_data(
  data_dir, "2024-11 E1 growth measurements.xlsx",
  c("diameter", "height", "health")
)

# Combine E1 tables
e1 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e1_2023, e1_2024_cankers, e1_2024_growth)
)

head(e1)

```

### Experiment 2

```{r load_data_E2}

e2_2024_05 <- load_data(
  data_dir, "2024-05 E2 growth measurements.xlsx", "diameter"
)

e2_2024_09_cankers <- load_data(
  data_dir, "2024-09-24 E2 canker assessment.xlsx", c(
    "rasp_inoculations", "rasp_cankers",
    "leaf_scar_inoculations", "leaf_scar_cankers", "health"
  )
)

e2_2024_12_growth <- load_data(
  data_dir, "2024-12 E2 growth measurements.xlsx",
  c("diameter", "height", "feather", "health")
)

# Combine E2 tables

e2 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    merge(x, y, by = common_cols, all = TRUE)
  }, 
  list(e2_2024_05, e2_2024_09_cankers, e2_2024_12_growth)
)

head(e2)

View(e2)

```

### Experiment 3

```{r load_data_E3}

e3_2024_10_growth <- load_data(
  data_dir, "2024-10 E3 growth measurements.xlsx", "data"
)

# head(e3_2024_10_growth)

```

### Experiment 4

```{r load_data_E4}

e4_2024_12_growth <- load_data(
  data_dir, "2024-12 E4 growth measurements.xlsx", c("diameter")
)

# head(e4_2024_12_growth)

```

## Tree health

```{r tree_health}

# Summarise tree health
e1[!is.na(health), .(health = paste0(health, collapse = ",")), by = .(tree, pot)]$health

# e1[, health_list := list(list(health[!is.na(health)])), by = .(tree, pot)]

# Plot tree health

```

## Data cleaning

```{r data_cleaning}

# Remove dead trees
e1 <- e1[health != "dead"]



```

## Plots

```{r plots}

# Summarise data by plot, taking the sum of canker measurements
e1_canker_summary <- e1[
  !is.na(cankers), .(block, plot, duration, cankers, inoc_points)
][, .(
  cankers = sum(cankers, na.rm = TRUE),
  inoc_points = sum(inoc_points, na.rm = TRUE),
  N = .N
), by = .(block, plot, duration)][, proportion := cankers / inoc_points]

e1_canker_summary
# Quick boxplot of total_cankers by treatment

ggboxplot(e1_canker_summary, x = "duration", y = "proportion",
  color = "duration", palette = "jco",
  add = "jitter",
  title = "Total Cankers by Treatment",
  xlab = "Treatment", ylab = "Total Cankers"
) + theme(legend.position = "none")

```

