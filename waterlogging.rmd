---
title: "Waterlogging Analysis"
author: "Hamish McLean"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: 
  html_document:
    toc: true
    toc_float: true
    highlight: tango
    theme: spacelab
    code_folding: hide
    # fig_caption: true
    # self_contained: false
    df_print: paged
---

## Setup

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, error = TRUE) #, message = FALSE, warning = FALSE)

```

```{r load_packages, include = FALSE}

library(car)
library(data.table)
library(DHARMa)
library(dplyr)
library(emmeans)
library(ggpubr)
library(glmmTMB)
library(here)
library(lme4)
library(lmerTest)
library(performance)
library(readxl)

```

```{r constants}

# Set the working directory to the project root
# here::set_here()

# Set data and figures directories
data_dir    <- here("..", "Data")
figures_dir <- here("figures")

# Model designs
E1_DESIGN <- ~ timepoint * duration + (1 | block) + (1 | tree) + (1 | pot)
E2_DESIGN <- ~ timepoint * duration + (1 | block) + (1 | tree) + (1 | pot)
E3_DESIGN <- ~ (timepoint + genotype) * treatment + (1 | block / splitPlot) + (1 | tree)
E4_DESIGN <- ~ timepoint * treatment + (1 | block) + (1 | tree)

E1_E2_DESIGN <- ~ (timepoint + experiment) * duration + (1 | experiment:block) + (1 | experiment:tree) + (1 | experiment:pot)


# Load custom functions
source(here("functions", "load_data.R"))

latte <- list(
  red = "#d20f39",
  yellow = "#df8e1d",
  green = "#40a02b",
  text = "#4c4f69"
)

```

## Load data

### Experiment 1

```{r load_data_E1}

e1_2023 <- load_data(
  data_dir, "2023 E1 growth measurements.xlsx",
  c(
    "d_spring", "d_fall", "h_spring", "h_fall", "health_fall",
    "mainstem", "peripheral", "inoc_points", "aborted", "inoc_cankers"
  )
)

# Combine diameter and height measurements
e1_2023[, diameter := coalesce(d_spring, d_fall)]
e1_2023[, height   := coalesce(h_spring, h_fall)]
e1_2023[, c("d_spring", "d_fall", "h_spring", "h_fall") := NULL]

# Rename health_fall to health
e1_2023[, health := health_fall][, health_fall := NULL]

# Calculate total cankers
e1_2023[,
  cankers := rowSums(.SD, na.rm = FALSE),
  .SDcols = c("mainstem", "peripheral")
]

e1_2024_cankers <- load_data(
  data_dir, "2024-09-23 E1 canker assessment.xlsx", "cankers"
)

e1_2024_growth <- load_data(
  data_dir, "2024-11 E1 growth measurements.xlsx",
  c("diameter", "height", "health")
)

e1_2023_cankers <- e1_2023[, c(
  "block", "plot", "pot",  "duration", "timepoint", "inoculation",
  "inoc_points", "cankers"
)]

# Combine E1 tables

common_cols <- intersect(colnames(e1_2023), colnames(e1_2024_cankers))
e1 <- merge(e1_2023, e1_2024_cankers, by = common_cols, all = TRUE)

common_cols <- intersect(colnames(e1_2024_cankers), colnames(e1_2024_growth))
e1 <- merge(e1, e1_2024_growth, by = common_cols, all = TRUE)

e1[, diameter := coalesce(diameter.x, diameter.y)][, c("diameter.x", "diameter.y") := NULL]
e1[, height := coalesce(height.x, height.y)][, c("height.x", "height.y") := NULL]
e1[, health := coalesce(health.x, health.y)][, c("health.x", "health.y") := NULL]

# Add experiment id column
e1[, experiment := "E1"]

# head(e1)

```

### Experiment 2

```{r load_data_E2}

e2_2024_05 <- load_data(
  data_dir, "2024-05 E2 growth measurements.xlsx", "diameter"
)

e2_2024_09_cankers <- load_data(
  data_dir, "2024-09-24 E2 canker assessment.xlsx", c(
    "rasp_inoculations", "rasp_cankers",
    "leaf_scar_inoculations", "leaf_scar_cankers"
  )
)

e2_2024_12_growth <- load_data(
  data_dir, "2024-12 E2 growth measurements.xlsx",
  c("diameter", "height", "feather", "health")
)

e2_2025_08_growth <- load_data(
  data_dir, "2025-08 E2 growth measurements.xlsx",
  c("diameter", "height", "health")
)

e2_2025_09_canker <- load_data(
  data_dir, "2025-09 E2 canker assessment.xlsx",
  c("rasp_cankers", "leaf_scar_cankers")
)


# Combine E2 tables

merge_cols <- c(
  "diameter", "height", "health",
  "rasp_cankers", "leaf_scar_cankers"
)

e2 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    common_cols <- common_cols[!common_cols %in% merge_cols]
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e2_2024_05, e2_2024_09_cankers, e2_2024_12_growth, e2_2025_08_growth, e2_2025_09_canker)
)

e2[, diameter := coalesce(diameter, diameter.x, diameter.y)][, c("diameter.x", "diameter.y") := NULL]
e2[, health := coalesce(health.x, health.y)][, c("health.x", "health.y") := NULL]
e2[, height := coalesce(height.x, height.y)][, c("height.x", "height.y") := NULL]
e2[, rasp_cankers := coalesce(rasp_cankers.x, rasp_cankers.y)][, c("rasp_cankers.x", "rasp_cankers.y") := NULL]
e2[, leaf_scar_cankers := coalesce(leaf_scar_cankers.x, leaf_scar_cankers.y)][, c("leaf_scar_cankers.x", "leaf_scar_cankers.y") := NULL]

# Add experiment id column
e2[, experiment := "E2"]

# Add height at T1 by subtracting feather at T2 from height at T2
e2 <- merge(
  e2,
  e2[(!is.na(height) & !is.na(feather)), .(tree, height = height - feather, timepoint = "T1")],
  by = c("tree", "timepoint"),
  all.x = TRUE
)
e2[, height := coalesce(height.x, height.y)][, c("height.x", "height.y") := NULL]

# head(e2)

```

### Experiment 3

```{r load_data_E3}

e3_2024_10_growth <- load_data(
  data_dir, "2024-10 E3 growth measurements.xlsx", "data"
)

e3_2025_05_cankers <- load_data(
  data_dir, "2025-05 E3 canker assessment.xlsx", c(
    "inoculations", "cankers"
  )
)

e3_2025_09_cankers <- load_data(
  data_dir, "2025-09 E3 canker assessment.xlsx", c(
    "inoculations", "cankers"
  )
)

e3_2025_09_growth <- load_data(
  data_dir, "2025-09 E3 growth measurements.xlsx", "data"
)

# e3_2024_10_growth |> head()
# e3_2025_05_cankers |> head()

# Combine E3 tables

merge_cols <- c(
  "diameter", "height", "health",
  "rasp_cankers", "leaf_scar_cankers",
  "rasp_inoculations", "scar_inoculations"
)

e3 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    common_cols <- common_cols[!common_cols %in% merge_cols]
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e3_2024_10_growth, e3_2025_05_cankers, e3_2025_09_cankers, e3_2025_09_growth)
)[, experiment := "E3"]

e3[, diameter := coalesce(diameter.x, diameter.y)][, c("diameter.x", "diameter.y") := NULL]
e3[, height := coalesce(height.x, height.y)][, c("height.x", "height.y") := NULL]
e3[, health := coalesce(health.x, health.y)][, c("health.x", "health.y") := NULL]
e3[, rasp_cankers := coalesce(rasp_cankers.x, rasp_cankers.y)][, c("rasp_cankers.x", "rasp_cankers.y") := NULL]
e3[, leaf_scar_cankers := coalesce(leaf_scar_cankers.x, leaf_scar_cankers.y)][, c("leaf_scar_cankers.x", "leaf_scar_cankers.y") := NULL]
e3[, rasp_inoculations := coalesce(rasp_inoculations.x, rasp_inoculations.y)][, c("rasp_inoculations.x", "rasp_inoculations.y") := NULL]

e3[, treatment := factor(treatment, levels = c(
  "Control", "Autumn", "Winter", "Spring"
))]

setnames(e3, "split-plot", "splitPlot")

# head(e3)

```

### Experiment 4

```{r load_data_E4}

e4_2024_12_growth <- load_data(
  data_dir, "2024-12 E4 growth measurements.xlsx", "diameter"
)

e4_2025_05_cankers <- load_data(
  data_dir, "2025-05 E4 canker assessment.xlsx", c(
    "inoculations", "cankers"
  )
)

e4_2025_09_growth <- load_data(
  data_dir, "2025-09 E4 growth measurements.xlsx", c("diameter", "extension_mean")
)

e4_extension <- load_data(
  data_dir, "2025-09 E4 growth measurements.xlsx", "extension"
)

# e4_2024_12_growth |> head()
# e4_2025_05_cankers |> head()

# Combine E4 tables

merge_cols <- c(
  "diameter", "height", "health",
  "rasp_cankers", "leaf_scar_cankers",
  "rasp_inoculations", "scar_inoculations"
)

e4 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    common_cols <- common_cols[!common_cols %in% merge_cols]
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e4_2024_12_growth, e4_2025_05_cankers, e4_2025_09_growth, e4_extension)
)[, experiment := "E4"]

e4[, diameter := coalesce(diameter.x, diameter.y)][, c("diameter.x", "diameter.y") := NULL]
e4[, health := coalesce(health.x, health.y)][, c("health.x", "health.y") := NULL]
# e4[, rasp_cankers := coalesce(rasp_cankers.x, rasp_cankers.y)][, c("rasp_cankers.x", "rasp_cankers.y") := NULL]
# e4[, leaf_scar_cankers := coalesce(leaf_scar_cankers.x, leaf_scar_cankers.y)][, c("leaf_scar_cankers.x", "leaf_scar_cankers.y") := NULL]
# e4[, rasp_inoculations := coalesce(rasp_inoculations.x, rasp_inoculations.y)][, c("rasp_inoculations.x", "rasp_inoculations.y") := NULL]

e4[, treatment := factor(paste0(season, duration))]

# head(e4)
# names(e4)

```

## Tree health

```{r tree_health}

#' @title Summarise tree health
#'
summarise_tree_health <- function(data) {

  # Check columns
  if (!all(c(
    "experiment", "timepoint", "duration", "health"
  ) %in% colnames(data))) {
    stop("Input data does not contain required columns.")
  }

  data_copy <- copy(data[, .(experiment, timepoint, duration, health)])

  # Combine health categories
  health_mapping <- list(
    healthy = c("healthy", "top_broken", "broken"),
    unhealthy = c("nearly_dead", "unhealthy", "top_dead")
  )
  data_copy[, health := fcase(
    health %in% health_mapping$healthy, "healthy",
    health %in% health_mapping$unhealthy, "unhealthy",
    rep(TRUE, .N), health # Keep other categories unchanged
  )]

  health_summary <- data_copy[!is.na(health), .N, by = .(
    experiment, timepoint, duration, health
  )]
  health_combinations <- CJ(
    experiment = unique(data_copy$experiment),
    timepoint = unique(data_copy$timepoint),
    duration = unique(data_copy$duration),
    health = c("healthy", "unhealthy", "dead", "missing")
  )
  health_summary <- merge(
    health_combinations,
    health_summary,
    by = c("experiment", "timepoint", "duration", "health"),
    all.x = TRUE
  )
  health_summary[is.na(N), N := 0] # Replace NA with 0 for missing combinations

  health_summary[, health := factor(
    health, levels = c("healthy", "unhealthy", "dead", "missing")
  )]

}

#' @title Summarise tree health
#'
summarise_tree_health <- function(data, by) {

  # Check columns
  if (!all(by %in% colnames(data))) {
    stop("Input data does not contain required columns.")
  }

  data_copy <- copy(data[, ..by])

  # # Combine health categories
  # health_mapping <- list(
  #   healthy = c("healthy", "top_broken", "broken"),
  #   unhealthy = c("nearly_dead", "unhealthy", "top_dead")
  # )
  # Class all living trees as healthy
  health_mapping <- list(
    healthy = c(
      "healthy", "top_broken", "broken", "nearly_dead", "unhealthy", "top_dead"
    )
  )

  data_copy[, health := fcase(
    health %in% health_mapping$healthy, "healthy",
    # health %in% health_mapping$unhealthy, "unhealthy",
    rep(TRUE, .N), health # Keep other categories unchanged
  )]
  health_levels <- c("healthy", "dead", "missing")

  # Generate all combinations of by columns and health
  # comb_list <- lapply(by, function(col) {
  #   ifelse(col == "health", health_levels, unique(data_copy[[col]]))
  # })
  comb_list <- lapply(by, function(col) unique(data_copy[[col]]))
  names(comb_list) <- by
  comb_list$health <- c("healthy", "dead", "missing")
  health_combinations <- do.call(CJ, comb_list)

  # Summarise health data
  health_summary <- data_copy[!is.na(health), .N, by = by]

  health_summary <- merge(
    health_combinations,
    health_summary,
    by = by,
    all.x = TRUE
  )

  health_summary[is.na(N), N := 0] # Replace NA with 0 for missing combinations

  # Reorder health factor levels
  health_summary[, health := factor(
    health, levels = health_levels
  )]

}

e1_health_summary <- summarise_tree_health(
  e1, c("experiment", "timepoint", "duration", "health")
)

e2_health_summary <- summarise_tree_health(
  e2, c("experiment", "timepoint", "duration", "health")
)

e3_health_summary <- summarise_tree_health(
  e3, c("experiment", "timepoint", "treatment", "genotype", "health")
)

e4_health_summary <- summarise_tree_health(
  e4, c("experiment", "timepoint", "treatment", "health")
)

```

### Tree health plots

```{r tree_health_plots}

plot_tree_health <- function(health_summary, x, facet_rows = NULL) {
  p <- ggbarplot(
    health_summary,
    x = x,
    y = "N",
    fill = "health",
    color = "health",
    # position = position_dodge(0.8),
    legend = "right",
    palette = c(
      healthy = latte$green,
      # unhealthy = latte$yellow,
      dead = latte$red
      # missing = latte$text
    )
  )

  if (!is.null(facet_rows)) {
    p <- p + facet_wrap(vars(!!sym(facet_rows)), ncol = 2)
  }

  p + labs(
    # title = "Tree Health by Treatment",
    x = paste("Waterlogging", x),
    y = "Number of Trees"
    # fill = "Health Category"
  )
}

# plot_tree_health(e1_health_summary)

# plot_tree_health(e2_health_summary)

plot_tree_health(
  bind_rows(e1_health_summary, e2_health_summary)[timepoint == "T2"],
  "duration", "experiment"
)
ggsave(filename = "tree_health_e1_e2.png", path = figures_dir)

plot_tree_health(
  e3_health_summary[
    timepoint == "T1" & health %in% c("healthy", "dead")
  ][,
    health := factor(health, levels = c("dead", "healthy"))
  ],
  "treatment", "genotype"
)
ggsave(
  filename = "tree_health_e3_wide.png", path = figures_dir,
  width = 20, height = 9, units = "cm"
)

plot_tree_health(e4_health_summary[timepoint == "T2"], "treatment")
ggsave(filename = "tree_health_e4.png", path = figures_dir)

```

## Tree health models

Binomial mixed effects model using `glmer`.

### Experiments 1 & 2

Experiments 1 & 2 combined.
Design includes `experiment` as a fixed effect.

DHARMa results fine. 
Binned residuals out of bounds and collinearity very high. 
Is this data suitable for modelling at all?

```{r tree_health_models_E1_E2}

# Class all living trees as healthy
healthy <-  c(
  "healthy", "top_broken", "broken", "nearly_dead", "unhealthy", "top_dead"
)

# Combine E1 and E2

e1_e2_health <- rbind(e1, e2, fill = TRUE)[
  !is.na(health) & timepoint == "T2"
][, health := fcase(
  health %in% healthy, "healthy",
  health == "dead", "dead"
) |> as.factor()]

design <- health ~ experiment * duration + (1 | experiment:block)

health_model <- glmer(
  design,
  data = e1_e2_health,
  family = binomial(link = "logit"),
  # control = glmerControl(optimizer = "bobyqa")
)

# Check model assumptions
check_model(health_model)

# sim <- simulateResiduals(health_model)
# plot(sim)
# testOverdispersion(sim)
# testZeroInflation(sim)

# summary(health_model)
Anova(health_model, type = 3) |> print()
# ranova(health_model, type = 3)
# emmeans(health_model, ~ duration | experiment) |> plot()

```


### Experiment 3

This model would not converv the full 

DHARMa results fine.
Some binned residuals out of bounds.

```{r tree_health_models_E3}

e3_health <- copy(e3)
# setnames(e3_health, "split-plot", "splitPlot")
e3_health <- e3_health[!is.na(health)][
  ,
  health := fcase(
    health %in% healthy, "healthy",
    health == "dead", "dead"
  ) |> as.factor()
]

design <- health ~ treatment * genotype + (1 | block / splitPlot)

health_model_e3 <- glmer(
  design,
  data = e3_health,
  family = binomial(link = "logit")
)

# Look for cells with 0 counts for either 'healthy' or 'dead'
# xtabs(~ health + treatment + genotype, data = e3_health)


# Check model assumptions
check_model(health_model_e3)

# sim <- simulateResiduals(health_model_e3)
# plot(sim)
# testOverdispersion(sim)

# summary(health_model_e3)
# exp(fixef(health_model_e3)) # Odds ratios
Anova(health_model_e3, type = 3) |> print()
# ranova(health_model_e3, type = 3)
# emmeans(health_model_e3, ~ duration | experiment) |> plot()

```

### Experiment 4

```{r tree_health_models_E4, eval = FALSE}

e4_health <- e4[!is.na(health)][,
  health := fcase(
    health %in% healthy, "healthy",
    health == "dead", "dead"
  ) |> as.factor()
]

health_model_e4 <- glmer(
  health ~ treatment + (1 | block),
  data = e4_health,
  family = binomial(link = "logit")
)

# Check model assumptions
check_model(health_model_e4)

# sim <- simulateResiduals(health_model_e4)
# plot(sim)
# testOverdispersion(sim)

# summary(health_model_e4)
# exp(fixef(health_model_e4)) # Odds ratios
Anova(health_model_e4, type = 3) |> print()
# ranova(health_model_e4, type = 3)
# emmeans(health_model_e4, ~ duration | experiment) |> plot()
emm_health_e4 <- emmeans(health_model_e4, trt.vs.ctrl ~ treatment)
print(emm_health_e4)
plot(emm_health_e4)



# # Summarise health data for E1 and E2 at T2
# e1_e2_health <- rbind(e1, e2, fill = TRUE)[
#   timepoint == "T2" & !is.na(health),
#   .(healthy = sum(health %in% healthy), dead = sum(health == "dead")),
#   by = .(experiment, block, duration)
# ][, experiment := factor(experiment)]

# design <- y ~ experiment * duration + (1 | experiment / block)

# health_model <- glmmTMB(
#   update(design, cbind(healthy, dead) ~ .),
#   data = e1_e2_health,
#   family = betabinomial(link = "logit")
# )

# health_model <- glmer(
#   update(design, cbind(healthy, dead) ~ .),
#   data = e1_e2_health,
#   family = binomial(link = "probit")
# )

# # Check model assumptions
# check_model(health_model)
# check_overdispersion(health_model)

# sim <- simulateResiduals(health_model)
# plot(sim)
# testDispersion(sim)

# summary(health_model)
# Anova(health_model, type = 3) |> print()
# # ranova(health_model, type = 3)
# emmeans(health_model, ~ duration | experiment) |> plot()

```

## Data cleaning

Remove pots with 2 or more dead or missing trees.
Remove dead trees.
Remove E2 pot 33

```{r data_cleaning}

# Remove pots with 2 or more dead or missing trees
remove_dead_pots <- function(data) {
  pots_to_remove <- unique(data[
    health == "dead" | health == "missing", .N, by = .(pot, timepoint)
  ][N >= 2, .(pot)])

  cat(
    "Removed", nrow(pots_to_remove),
    "pots with 2 or more dead or missing trees\n\n"
  )

  data[!.(pots_to_remove), on = .(pot)]
}

cat("Experiment 1\n")
e1 <- remove_dead_pots(e1)
cat("Experiment 2\n")
e2 <- remove_dead_pots(e2)

# Remove dead trees
remove_dead_trees <- function(data) {
  trees_to_remove <- data[health == "dead" | health == "missing", tree]
  cat("Removed", length(trees_to_remove), "remaining dead or missing trees\n\n")
  data[!(tree %in% trees_to_remove), ]
}

cat("Experiment 1\n")
e1 <- remove_dead_trees(e1)
cat("Experiment 2\n")
e2 <- remove_dead_trees(e2)

# Remove dead trees
remove_dead_trees <- function(data) {
  trees_to_remove <- data[health == "dead" | health == "missing", pot]
  cat("Removed", length(trees_to_remove), "remaining dead or missing trees\n\n")
  data[!(pot %in% trees_to_remove), ]
}

cat("Experiment 3\n")
e3 <- remove_dead_trees(e3)
cat("Experiment 4\n")
e4 <- remove_dead_trees(e4)

# Remove trees which are missing at any timepoint
remove_corresponding <- function(data) {

}


# Remove E1 8 week duration
e1 <- e1[duration != 8]

# Remove E2 pot 33
e2 <- e2[pot != 33]

# Combine E1 and E2 data
e1_e2 <- rbind(e1, e2, fill = TRUE)

```

## Growth

```{r growth functions}

#' @title Summarise growth data
#'
summarise_growth <- function(data, measurement, remove_health = NULL) {
  # Check columns
  if (!all(c(
    "experiment", "timepoint", "duration", measurement
  ) %in% colnames(data))) {
    stop("Input data does not contain required columns.")
  }

  # Summarise data by measurement
  data[
    !is.na(get(measurement)) & !(health %in% remove_health),
    .(
      mean = mean(get(measurement), na.rm = TRUE),
      median = median(get(measurement), na.rm = TRUE),
      N = .N,
      sd = sd(get(measurement), na.rm = TRUE)
    ),
    by = .(experiment, timepoint, duration)
  ][, duration := factor(duration)]
}

#' @title Plot growth data
#'
plot_growth <- function(data, measurement) {
  units = if (measurement == "diameter") {
    "mm"
  } else if (measurement == "height") {
    "cm"
  } else {
    NULL
  }
  ggline(
    data,
    x = "timepoint",
    y = "mean",
    color = "duration"
  ) +
    labs(
      title = measurement, #paste(measurement, "by Treatment"),
      x = "Timepoint",
      y = paste0(measurement, " (", units, ")")
    )
}

```

### Growth rate

```{r growth_rate}

growth_rate <- function(data, by, final = "T3") {
  # Filter data for T1 and T3 timepoints
  data_subset <- data[timepoint %in% c("T1", final)]

  # Remove height data for broken trees
  broken <- unique(data_subset[health %in% c("top_broken", "top_dead"), get(by)])
  data_subset[get(by) %in% broken, height := NA]

  # Identify factor columns
  factor_cols <- names(data)[sapply(data, is.factor)]
  factor_cols <- factor_cols[!factor_cols %in% c("timepoint", "height")]

  # Calculate growth rate for height
  height_growth <- data_subset[
    ,
    .(
      initial_height = height[timepoint == "T1"],
      final_height = height[timepoint == final]
    ),
    by = by
  ][, `:=`(
    height_absolute = final_height - initial_height,
    height_relative = (final_height - initial_height) / initial_height,
    height_relative_ln = log(final_height / initial_height)
  )]

  # Calculate growth rate for diameter
  diameter_growth <- data_subset[
    ,
    .(
      initial_diameter = diameter[timepoint == "T1"],
      final_diameter = diameter[timepoint == final]
    ),
    by = by
  ][, `:=`(
    diameter_absolute = final_diameter - initial_diameter,
    diameter_relative = (final_diameter - initial_diameter) / initial_diameter,
    diameter_relative_ln = log(final_diameter / initial_diameter)
  )]

  # Retain factor columns
  factor_data <- unique(data_subset[, .SD, .SDcols = unique(c(by, factor_cols))], by = by)

  # Merge height and diameter growth rates
  growth_data <- merge(height_growth, diameter_growth, by = by, all = TRUE)
  merge(factor_data, growth_data, by = by, all.x = TRUE)
}


e1_growth <- growth_rate(e1, "tree")
e2_growth <- growth_rate(e2, "tree")
# e1_e2_growth <- growth_rate(e1_e2, "tree")

e3_growth <- growth_rate(e3, "pot", "T2")
e4_growth <- growth_rate(e4, "pot", "T2")

```

### Growth plots

```{r growth_plots}

# E1 combined

ggarrange(
  plot_growth(summarise_growth(e1, "diameter"), "diameter"),
  plot_growth(summarise_growth(e1, "height"), "height"),
  # with = 20, height = 15, units = "cm",
  # nrow = 1, ncol = 2,
  common.legend = TRUE, legend = "bottom"
)
ggsave(filename = "E1_growth_plots.png", path = figures_dir)

# E2 combined

ggarrange(
  plot_growth(summarise_growth(e2, "diameter"), "diameter"),
  plot_growth(summarise_growth(e2, "height"), "height"),
  # with = 20, height = 15, units = "cm",
  # nrow = 1, ncol = 2,
  common.legend = TRUE, legend = "bottom"
)
ggsave(filename = "E2_growth_plots.png", path = figures_dir)

```

```{r growth plots 2}

# Growth plots 2
plotGrowthE1E2 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "duration",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
  ) + labs(
    title = metric,
    x = "Waterlogging duration (weeks)"
    # y = "ln(height2 - height1)"
  )
}

ggarrange(
  plotGrowthE1E2(e1_growth, "height_relative_ln", "height"),
  plotGrowthE1E2(e1_growth, "diameter_relative_ln", "diameter")
)
ggsave(filename = "growth_E1.png", path = figures_dir)

ggarrange(
  plotGrowthE1E2(e2_growth, "height_relative_ln", "height"),
  plotGrowthE1E2(e2_growth, "diameter_relative_ln", "diameter")
)
ggsave(filename = "growth_E2.png", path = figures_dir)


plotGrowthE3 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "treatment",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
    # facet.by = "genotype"
  ) + facet_wrap(~ genotype, ncol = 1) + labs(
    title = metric,
    x = "Waterlogging season"
    # y = "ln(height2 - height1)"
  )
}

ggarrange(
  plotGrowthE3(e3_growth, "height_relative_ln", "height"),
  plotGrowthE3(e3_growth, "diameter_relative_ln", "diameter")
  # ncol = 1
)
ggsave(filename = "growth_E3.png", path = figures_dir)


plotGrowthE4 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "treatment",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
  ) + labs(
    title = metric,
    x = "Waterlogging treatment"
    # y = "ln(height2 - height1)"
  )
}

plotGrowthE4(e4_growth, "diameter_relative_ln", "diameter")
ggsave(filename = "growth_E4.png", path = figures_dir)

```

### Diameter

#### Experiment 1 & 2

```{r diameter E1}

# # E1 diameter plot
# plot_growth(
#   summarise_growth(e1, "diameter"),
#   "diameter"
# )

# # E2 diameter plot
# plot_growth(
#   summarise_growth(e2, "diameter"),
#   "diameter"
# )

# Models

design <- y ~ duration + (1 | block) + (1 | pot)

# E1 diameter model

e1_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e1_growth)
check_model(e1_diameter_model)
Anova(e1_diameter_model, type = 3) |> print()
emmeans(e1_diameter_model, trt.vs.ctrl ~ duration)


# E2 diameter model

e2_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e2_growth)
check_model(e2_diameter_model)
# summary(e2_diameter_model)
Anova(e2_diameter_model, type = 3) |> print()
emm_diameter_e2 <- emmeans(e2_diameter_model, trt.vs.ctrl ~ duration)
print(emm_diameter_e2)
plot(emm_diameter_e2)


# E1 & E2 model

# design <- y ~ experiment + duration + elapsed_years + experiment:duration + duration:elapsed_years + (1 | experiment / tree) + (1 | experiment / block)

# design <- y ~ treatment * experiment * timepoint + (1 | experiment:block) + (1 | experiment:tree) + (1 | experiment:pot)

design <- ~ experiment * duration + (1 | experiment:block) + (1 | experiment:pot)

e1_e2_diameter_model <- lmer(
  update(design, diameter_relative_ln ~ .),
  data = e1_e2_growth[duration != 8]
)

check_model(e1_e2_diameter_model)
# summary(e1_e2_diameter_model)
Anova(e1_e2_diameter_model, type = 3) |> print()
emm_diameter_e1_e2 <- emmeans(e1_e2_diameter_model, trt.vs.ctrl ~ duration | experiment | timepoint)
print(emm_diameter_e1_e2)
plot(emm_diameter_e1_e2)


# E3
design <- y ~ genotype * treatment + (1 | block / splitPlot)

e3_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e3_growth)
check_model(e3_diameter_model)
Anova(e3_diameter_model, type = 3) |> print()
emmeans(e3_diameter_model, pairwise ~ genotype) |> plot()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype) |> plot()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype)


# E4
design <- y ~ treatment + (1 | block)

e4_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e4_growth)
check_model(e4_diameter_model)
Anova(e4_diameter_model, type = 3) |> print()
emmeans(e4_diameter_model, trt.vs.ctrl ~ treatment)
emmeans(e4_diameter_model, trt.vs.ctrl ~ treatment) |> plot()


```

### Height

```{r height}

top_removals <- c("top_broken", "top_missing")

design <- ~ duration + (1 | block) + (1 | pot)


# E1 height model

e1_height_model <- lmer(update(design, height_relative_ln ~ .), data = e1_growth)
# Check model assumptions
check_model(e1_height_model)
# summary(e1_height_model)
Anova(e1_height_model, type = 3) |> print()
emmeans(e1_height_model, trt.vs.ctrl ~ duration)

# E2 height model

e2_height_model <- lmer(update(design, height_relative_ln ~ .), data = e2_growth)
# Check model assumptions
check_model(e2_height_model)
# summary(e2_height_model)
Anova(e2_height_model, type = 3) |> print()
emm_height <- emmeans(e2_height_model, trt.vs.ctrl ~ duration)
print(emm_height)
plot(emm_height) #, comparisons = TRUE)


# E1 & E2 model

e1_e2_height_model <- lmer(
  update(E1_E2_DESIGN, height ~ .),
  data = e1_e2[!(health %in% top_removals) & duration != 8]
)

check_model(e1_e2_height_model)
# summary(e1_e2_height_model)
Anova(e1_e2_height_model, type = 3) |> print()
emm_height_e1_e2 <- emmeans(e1_e2_height_model, trt.vs.ctrl ~ duration | experiment | timepoint)
print(emm_height_e1_e2)
plot(emm_height_e1_e2)


# E3
design <- y ~ genotype * treatment + (1 | block / splitPlot)

e3_diameter_model <- lmer(update(design, height_relative_ln ~ .), data = e3_growth)
check_model(e3_diameter_model)
Anova(e3_diameter_model, type = 3) |> print()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype)


```

```{r extension, eval = FALSE}

# Summarise feather
e2_feather_summary <- e2[
  !is.na(feather) & !(health %in% top_removals),
  .(block, plot, duration, feather)
][, .(
  feather = mean(feather, na.rm = TRUE),
  N = .N,
  sd = sd(feather, na.rm = TRUE)
), by = .(block, plot, duration)][, duration := factor(duration)]

ggboxplot(
  e2_feather_summary,
  x = "duration",
  y = "feather",
  color = "duration",
  add = "jitter"
) +
  labs(
    title = "Extension by Treatment",
    x = "Waterlogging duration (weeks)",
    y = "Extension (cm)"
  )

# E2 extension model
e2_extension_model <- lmer(
  log(feather) ~ duration + (1 | block) + (1 | pot),
  data = e2[!(health %in% top_removals)][, duration := factor(duration)]
)

# Check model assumptions
check_model(e2_extension_model)

summary(e2_extension_model)
Anova(e2_extension_model, type = 3) |> print()
emmeans(e2_extension_model, ~ duration)

```

## Canker plots

### Experiment 1

```{r E1 canker plots}

e1_canker_summary <- e1[
  !is.na(cankers), .(block, plot, duration, cankers, inoc_points)
][
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoc_points = sum(inoc_points, na.rm = TRUE),
    N = .N
  ), by = .(block, plot, duration)
][, proportion := cankers / inoc_points]

# ggboxplot(e1_canker_summary, x = "duration", y = "proportion",
#   color = "duration", palette = "jco",
#   add = "jitter",
#   title = "Total Cankers by Treatment",
#   xlab = "Treatment", ylab = "Total Cankers"
# ) + theme(legend.position = "none")

ggerrorplot(
  data = e1_canker_summary,
  x = "duration",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci",
  size = 1,
  position = position_dodge(0.5),
  add.params = list(alpha = 0.5)
) + labs(
  title = "Experiment 1: winter waterlogging timing",
  x = "Waterlogging duration (weeks)",
  y = "Cankers per inoculation point"
)
ggsave(filename = "canker_plots_E1.png", path = figures_dir)

```

### Experiment 2

```{r E2 canker plots}

e2_canker_summary <- e2[
  !is.na(rasp_inoculations), .(
    block, plot, duration,
    rasp_cankers, rasp_inoculations
  )
][, .(
  rasp_cankers = sum(rasp_cankers, na.rm = TRUE),
  rasp_inoculations = sum(rasp_inoculations, na.rm = TRUE),
  N = .N
), by = .(block, plot, duration)][,
  proportion := rasp_cankers / rasp_inoculations
]

# ggboxplot(e2_canker_summary,
#   x = "duration", y = "proportion",
#   color = "duration", palette = "jco",
#   add = "jitter",
#   title = "Proportion of cankers by Treatment",
#   xlab = "Waterlogging duration (weeks)", ylab = "Cankers per inoculation point"
# ) + theme(legend.position = "none")

ggerrorplot(
  data = e2_canker_summary,
  x = "duration",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci",
  size = 1,
  position = position_dodge(0.5),
  add.params = list(alpha = 0.5)
) + labs(
  title = "Experiment 2: winter waterlogging duration",
  x = "Waterlogging duration (weeks)",
  y = "Cankers per inoculation point"
)
ggsave(filename = "canker_plots_E2.png", path = figures_dir)

```

### Experiment 3

```{r E3 canker plots}

e3_canker_summary <- melt(
  e3[timepoint == "T2" & (!is.na(rasp_inoculations) | !is.na(leaf_scar_inoculations)), ],
  id.vars = c("block", "plot", "treatment", "genotype"),
  variable.name = "type",
  measure = list(
    cankers = c("rasp_cankers", "leaf_scar_cankers"),
    inoculations = c("rasp_inoculations", "leaf_scar_inoculations")
  ),
)[
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoculations = sum(inoculations, na.rm = TRUE),
    N = .N
  ), by = .(plot, genotype, treatment, type)
][
  , `:=`(
    proportion = cankers / inoculations,
    type = factor(type, labels = c("rasp wound", "leaf scar"))
  )
]

ggerrorplot(
  data = e3_canker_summary,
  x = "treatment",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci", # mean and CI
  size = 0.6,
  position = position_dodge(0.5),
  ggtheme = theme_bw(),
  add.params = list(alpha = 0.3) # Set alpha for jitter points
) + facet_grid(
  type ~ genotype
) + labs(
  title = "Experiment 3: waterlogging timing and rootstock genotype",
  x = "Treatment",
  y = "Cankers per inoculation point"
)
ggsave(
  filename = "canker_plots_E3_T2.png", path = figures_dir,
  width = 15, height = 10, units = "cm"
)

```

### Experiment 4

```{r E4 canker plots}

e4_canker_summary <- melt(
  e4[timepoint == "T2" & (!is.na(rasp_inoculations) | !is.na(leaf_scar_inoculations)), ],
  id.vars = c("block", "plot", "treatment"),
  variable.name = "type",
  measure = list(
    cankers = c("rasp_cankers", "leaf_scar_cankers"),
    inoculations = c("rasp_inoculations", "leaf_scar_inoculations")
  ),
)[
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoculations = sum(inoculations, na.rm = TRUE),
    N = .N
  ), by = .(plot, treatment, type)
][
  , `:=`(
    proportion = cankers / inoculations,
    type = factor(type, labels = c("rasp wound", "leaf scar"))
  )
]

ggerrorplot(
  data = e4_canker_summary,
  x = "treatment",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci", # mean and CI
  size = 0.6,
  position = position_dodge(0.5),
  ggtheme = theme_bw(),
  add.params = list(alpha = 0.3) # Set alpha for jitter points
) + facet_grid(
  ~ type
) + labs(
  title = "Experiment 4: waterlogging timing and duration",
  x = "Treatment",
  y = "Cankers per inoculation point"
)
ggsave(
  filename = "canker_plots_E4_T2.png", path = figures_dir,
  width = 18, height = 10, units = "cm"
)

```

## Canker models

### Experiment 1

```{r E1 canker models, eval = FALSE}

e1_canker_data <- e1[!is.na(inoc_cankers)] |> as.data.frame()

# E1 canker model
e1_canker_model <- glmer(
  cbind(inoc_cankers, inoc_points - inoc_cankers) ~ duration + (1 | block) + (1 | inoculation),
  family = binomial(link = "logit"),
  data = e1_canker_data
)

# Check model assumptions
check_model(e1_canker_model)
plot(simulateResiduals(e1_canker_model))

# summary(e1_canker_model)
Anova(e1_canker_model, type = 3) |> print()
emmeans(e1_canker_model, trt.vs.ctrl ~ duration)

```

### Experiment 2

```{r E2 canker models}

# E2 canker model
e2_canker_model <- glmer(
  cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ duration + (1 | block) + (1 | inoculation),
  family = binomial(link = "logit"),
  data = e2[!is.na(rasp_cankers)][, duration := factor(duration)]
)

# Check model assumptions
check_model(e2_canker_model)
sim <- simulateResiduals(e2_canker_model)
plot(sim)
testZeroInflation(sim)

# Summary
# summary(e2_canker_model)
# exp(fixef(e2_canker_model)) # Odds ratios
Anova(e2_canker_model, type = 3) |> print()
emmeans(e2_canker_model, trt.vs.ctrl ~ duration)

```

### Experiment 3

```{r E3 canker models}

# design <- y ~ treatment * genotype + (1 | block) + (1 | pot)

# E3 rasp wound canker model
e3_rasp_canker_model <- glmer(
  cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ genotype * treatment + (1 | block / splitPlot) + (1 | inoculation_group),
  family = binomial(link = "logit"),
  data = e3[timepoint == "T2" & !is.na(rasp_cankers)]
)

# Check model assumptions
check_model(e3_rasp_canker_model)
sim <- simulateResiduals(e3_rasp_canker_model)
plot(sim)
# testZeroInflation(sim)

# Summary
# summary(e3_rasp_canker_model)
# exp(fixef(e3_rasp_canker_model)) # Odds ratios
Anova(e3_rasp_canker_model, type = 3) |> print()
# emmeans(e3_rasp_canker_model, specs = trt.vs.ctrl ~ treatment, by = "genotype", type = "response") |> plot()

emmeans(e3_rasp_canker_model, pairwise ~ genotype, type = "response")

emm_e3_rasp_canker <- emmeans(e3_rasp_canker_model, trt.vs.ctrl ~ treatment | genotype, type = "response")
print(emm_e3_rasp_canker)
plot(emm_e3_rasp_canker)


# E3 leaf scar canker model
e3_leaf_scar_canker_model <- glmer(
  cbind(leaf_scar_cankers, leaf_scar_inoculations - leaf_scar_cankers) ~ genotype * treatment + (1 | block / splitPlot) + (1 | inoculation_group),
  family = binomial(link = "logit"),
  data = e3[timepoint == "T2" & !is.na(leaf_scar_cankers)]
)

# Check model assumptions
check_model(e3_leaf_scar_canker_model)
sim <- simulateResiduals(e3_leaf_scar_canker_model)
plot(sim)
# testZeroInflation(sim)

# Summary
# summary(e3_leaf_scar_canker_model)
# exp(fixef(e3_leaf_scar_canker_model)) # Odds ratios
Anova(e3_leaf_scar_canker_model, type = 3) |> print()

# emmeans
emmeans(e3_leaf_scar_canker_model, pairwise ~ genotype, type = "response")
emmeans(e3_leaf_scar_canker_model, trt.vs.ctrl ~ treatment, type = "response") |> plot()

emm_e3_leaf_scar_canker <- emmeans(e3_leaf_scar_canker_model, trt.vs.ctrl ~ treatment | genotype)
print(emm_e3_rasp_canker)
plot(emm_e3_rasp_canker)

```

### Experiment 4

```{r E4 canker models}

# E4 rasp wound canker model
e4_canker_model <- glmer(
  cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ treatment + (1 | block),
  family = binomial(link = "logit"),
  data = e4[!is.na(rasp_cankers)]
)

# Check model assumptions
check_model(e4_canker_model)
sim <- simulateResiduals(e4_canker_model)
plot(sim)
# testOverdispersion(sim)
# testZeroInflation(sim)

# Summary
# summary(e4_canker_model)
# exp(fixef(e4_canker_model)) # Odds ratios
Anova(e4_canker_model, type = 3) |> print()
emm_e4_rasp_canker <- emmeans(e4_canker_model, trt.vs.ctrl ~ treatment)
print(emm_e4_rasp_canker)
plot(emm_e4_rasp_canker)


# E4 leaf scar canker model
e4_leaf_scar_canker_model <- glmer(
  cbind(leaf_scar_cankers, leaf_scar_inoculations - leaf_scar_cankers) ~ treatment + (1 | block),
  family = binomial(link = "logit"),
  data = e4[!is.na(leaf_scar_cankers)]
)

# Check model assumptions
check_model(e4_leaf_scar_canker_model)
sim <- simulateResiduals(e4_leaf_scar_canker_model)
plot(sim)
# testOverdispersion(sim)
# testZeroInflation(sim)

# Summary
# summary(e4_leaf_scar_canker_model)
# exp(fixef(e4_leaf_scar_canker_model)) # Odds ratios
Anova(e4_leaf_scar_canker_model, type = 3) |> print()
emm_e4_leaf_scar_canker <- emmeans(e4_leaf_scar_canker_model, trt.vs.ctrl ~ treatment)
print(emm_e4_leaf_scar_canker)
plot(emm_e4_leaf_scar_canker)

```