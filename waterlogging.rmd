---
title: "Waterlogging Analysis"
author: "Hamish McLean"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_packages}

library(data.table)
library(dplyr)
library(ggpubr)
library(here)
library(readxl)

```

```{r constants}

# Set the working directory to the project root
here::set_here()

# Set data and figures directories
data_dir    <- here("..", "Data")
figures_dir <- here("figures")

# Load custom functions
source(here("functions", "load_data.R"))

```

## Load data

### Experiment 1

```{r load_data_E1}

e1_2023 <- load_data(
  data_dir, "2023 E1 growth measurements.xlsx",
  c(
    "d_spring", "d_fall", "h_spring", "h_fall", "health_fall",
    "mainstem", "peripheral", "inoc_points", "aborted", "inoc_cankers"
  )
)

# Combine diameter and height measurements
e1_2023[, diameter := coalesce(d_spring, d_fall)]
e1_2023[, height   := coalesce(h_spring, h_fall)]
e1_2023[, c("d_spring", "d_fall", "h_spring", "h_fall") := NULL]

# Rename health_fall to health
e1_2023[, health := health_fall][, health_fall := NULL]

# Calculate total cankers
e1_2023[,
  cankers := rowSums(.SD, na.rm = FALSE),
  .SDcols = c("mainstem", "peripheral")
]

e1_2024_cankers <- load_data(
  data_dir, "2024-09-23 E1 canker assessment.xlsx", "cankers"
)

e1_2024_growth <- load_data(
  data_dir, "2024-11 E1 growth measurements.xlsx",
  c("diameter", "height", "health")
)

# Combine E1 tables
e1 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e1_2023, e1_2024_cankers, e1_2024_growth)
)

# Add experiment id column
e1[, experiment := "E1"]

head(e1)

```

### Experiment 2

```{r load_data_E2}

e2_2024_05 <- load_data(
  data_dir, "2024-05 E2 growth measurements.xlsx", "diameter"
)

e2_2024_09_cankers <- load_data(
  data_dir, "2024-09-24 E2 canker assessment.xlsx", c(
    "rasp_inoculations", "rasp_cankers",
    "leaf_scar_inoculations", "leaf_scar_cankers"
  )
)

e2_2024_12_growth <- load_data(
  data_dir, "2024-12 E2 growth measurements.xlsx",
  c("diameter", "height", "feather", "health")
)

# Combine E2 tables

e2 <- Reduce(
  function(x, y) {
    # Merge on common columns
    common_cols <- intersect(colnames(x), colnames(y))
    merge(x, y, by = common_cols, all = TRUE)
  },
  list(e2_2024_05, e2_2024_09_cankers, e2_2024_12_growth)
)

# Add experiment id column
e2[, experiment := "E2"]

head(e2)

# View(e2)

```

### Experiment 3

```{r load_data_E3}

e3_2024_10_growth <- load_data(
  data_dir, "2024-10 E3 growth measurements.xlsx", "data"
)

# head(e3_2024_10_growth)

```

### Experiment 4

```{r load_data_E4}

e4_2024_12_growth <- load_data(
  data_dir, "2024-12 E4 growth measurements.xlsx", c("diameter")
)

# head(e4_2024_12_growth)

```

## Tree health

```{r tree_health}

#' @title Summarise tree health
#'
summarise_tree_health <- function(data) {

  # Check columns
  if (!all(c(
    "experiment", "timepoint", "duration", "health"
  ) %in% colnames(data))) {
    stop("Input data does not contain required columns.")
  }

  data_copy <- copy(data[, .(experiment, timepoint, duration, health)])

  # Combine health categories
  health_mapping <- list(
    healthy = c("healthy", "top_broken", "broken"),
    unhealthy = c("nearly_dead", "unhealthy", "top_dead", "broken")
  )
  data_copy[, health := fcase(
    health %in% health_mapping$healthy, "healthy",
    health %in% health_mapping$unhealthy, "unhealthy",
    rep(TRUE, .N), health # Keep other categories unchanged
  )]

  health_summary <- data_copy[!is.na(health), .N, by = .(
    experiment, timepoint, duration, health
  )]
  health_combinations <- CJ(
    experiment = unique(data_copy$experiment),
    timepoint = unique(data_copy$timepoint),
    duration = unique(data_copy$duration),
    health = c("healthy", "unhealthy", "dead", "missing")
  )
  health_summary <- merge(
    health_combinations,
    health_summary,
    by = c("experiment", "timepoint", "duration", "health"),
    all.x = TRUE
  )
  health_summary[is.na(N), N := 0] # Replace NA with 0 for missing combinations

  health_summary[, health := factor(
    health, levels = c("healthy", "unhealthy", "dead", "missing")
  )]

}

e1_health_summary <- summarise_tree_health(e1)

e2_health_summary <- summarise_tree_health(e2)



plot_tree_health <- function(health_summary) {
  ggbarplot(
    health_summary,
    x = "health",          # Treatments on the x-axis
    y = "N",                 # Count of trees on the y-axis
    fill = "timepoint",         # Separate bars by health category
    color = "timepoint",        # Add color to distinguish health categories
    position = position_dodge(0.8), # Dodge bars for better separation
    # palette = ""          # Use a predefined color palette
  ) +
    facet_grid(cols = vars(duration), rows = vars(experiment)) +
    labs(
      title = "Tree Health by Treatment",
      x = "Treatment Duration",
      y = "Number of Trees"
      # fill = "Health Category"
    ) +
    theme_minimal()
}

# plot_tree_health(e1_health_summary)

# plot_tree_health(e2_health_summary)

plot_tree_health(bind_rows(e1_health_summary, e2_health_summary))


```

## Data cleaning

Remove pots with 2 or more dead or missing trees.
Remove dead trees.
Remove E2 pot 33

```{r data_cleaning}

# Remove pots with 2 or more dead or missing trees
remove_dead_pots <- function(data) {
  pots_to_remove <- unique(data[
    health == "dead" | health == "missing", .N, by = .(pot, timepoint)
  ][N >= 2, .(pot)])

  cat(
    "Removed", nrow(pots_to_remove),
    "pots with 2 or more dead or missing trees\n\n"
  )

  data[!.(pots_to_remove), on = .(pot)]
}

e1 <- remove_dead_pots(e1)
e2 <- remove_dead_pots(e2)

# Remove dead trees
remove_dead_trees <- function(data) {
  trees_to_remove <- data[health == "dead" | health == "missing"]
  cat("Removed", nrow(trees_to_remove), "remaining dead or missing trees\n\n")
  data[!.(trees_to_remove)]
}

e1 <- remove_dead_trees(e1)
e2 <- remove_dead_trees(e2)

# Remove E1 8 week duration
e1 <- e1[duration != 8]

# Remove E2 pot 33
e2 <- e2[pot != 33]

```

## Growth

### Diameter

```{r diameter}

# Summarise diameter
e1_diameter_summary <- e1[
  !is.na(diameter), .(timepoint, duration, diameter)
][, .(
  diameter = mean(diameter, na.rm = TRUE),
  N = .N,
  sd = sd(diameter, na.rm = TRUE)
), by = .(duration, timepoint)]

e1_diameter_summary[, duration := factor(duration)]

# Plot diameter against timepoint for each treatment
ggline(
  e1_diameter_summary,
  x = "timepoint",
  y = "diameter",
  color = "duration"
) +
  labs(
    title = "Diameter by Treatment",
    x = "Timepoint",
    y = "Diameter (mm)"
  )


```

### Height

```{r height}

top_removals <- c("top_broken", "top_missing")

# Sumarise height
e1_height_summary <- e1[
  !is.na(height) & !(health %in% top_removals), .(timepoint, duration, height)
][, .(
  height = mean(height, na.rm = TRUE),
  N = .N,
  sd = sd(height, na.rm = TRUE)
), by = .(duration, timepoint)][, duration := factor(duration)]

ggline(
  e1_height_summary,
  x = "timepoint",
  y = "height",
  color = "duration"
) +
  labs(
    title = "Height by Treatment",
    x = "Timepoint",
    y = "Height (cm)"
  )

```

### Feather

```{r feather}

# Summarise feather
e1_feather_summary <- e1[
  !is.na(feather) & !(health %in% top_removals), .(timepoint, duration, feather)
][, .(
  feather = mean(feather, na.rm = TRUE),
  N = .N,
  sd = sd(feather, na.rm = TRUE)
), by = .(duration, timepoint)][, duration := factor(duration)]

ggline(
  e1_feather_summary,
  x = "timepoint",
  y = "feather",
  color = "duration"
) +
  labs(
    title = "Feather by Treatment",
    x = "Timepoint",
    y = "Feather (cm)"
  )

```

## Canker

```{r plots}

# Summarise data by plot, taking the sum of canker measurements
e1_canker_summary <- e1[
  !is.na(cankers), .(block, plot, duration, cankers, inoc_points)
][, .(
  cankers = sum(cankers, na.rm = TRUE),
  inoc_points = sum(inoc_points, na.rm = TRUE),
  N = .N
), by = .(block, plot, duration)][, proportion := cankers / inoc_points]

e1_canker_summary
# Quick boxplot of total_cankers by treatment

ggboxplot(e1_canker_summary, x = "duration", y = "proportion",
  color = "duration", palette = "jco",
  add = "jitter",
  title = "Total Cankers by Treatment",
  xlab = "Treatment", ylab = "Total Cankers"
) + theme(legend.position = "none")

```
