---
title: "Waterlogging Analysis"
author: "Hamish McLean"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: 
  html_document:
    toc: true
    toc_float: true
    highlight: tango
    theme: spacelab
    code_folding: hide
    # fig_caption: true
    # self_contained: false
    df_print: paged
---

## Setup

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, error = TRUE) #, message = FALSE, warning = FALSE)

```

```{r load_packages, include = FALSE}

library(brglm2)
library(car)
library(data.table)
library(DHARMa)
library(dplyr)
library(emmeans)
library(ggpubr)
library(glmmTMB)
library(here)
library(lme4)
library(lmerTest)
library(performance)
library(readxl)
library(scales)

```

```{r constants}

# Set object and figures directories
data_dir    <- here("..", "Data")
object_dir  <- here("objects")
figures_dir <- here("figures")

latte <- list(
  red    = "#d20f39",
  yellow = "#df8e1d",
  green  = "#40a02b",
  text   = "#4c4f69"
)

```

## Load data

```{r load data}

e1 <- readRDS(here(object_dir, "e1.Rds"))
e2 <- readRDS(here(object_dir, "e2.Rds"))
e3 <- readRDS(here(object_dir, "e3.Rds"))
e4 <- readRDS(here(object_dir, "e4.Rds"))

```

## Tree mortality

Count of dead ond 'healthy' (not dead) trees summarised per plot (or per subplot
for experiment 3).

Binomial GLM fit to mortality matrix with Firth-type bias reduction.

```{r mortality models E1 E2}

mortalityByPlot <- function(data, timepoint = "T2") {
  data[timepoint == timepoint & !is.na(health)][
    , .(dead = sum(health == "dead"), total = .N),
    by = .(plot, block, duration, experiment, treatment)
  ][, mortality := dead / total]
}


# E1

model <- glm(
  cbind(dead, total - dead) ~ block + duration,
  data   = mortalityByPlot(e1),
  family = binomial(link = "logit"),
  method = brglmFit # Firth-type bias reduction
)
# check_model(model) # fine
# sim <- simulate_residuals(model)
# testResiduals(sim)
# testZeroInflation(sim)

summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ duration, type = "response")



# betabinomial

# model <- glmmTMB(
#   cbind(dead, total - dead) ~ block + duration,
#   data   = mortalityByPlot(e1),
#   family = betabinomial(link = "logit")
# )
# # simulate_residuals(model) |> plot()
# # check_model(model) # fine
# summary(model)
# anova(update(model, . ~ block), model, test = "LRT")
# emmeans(model, trt.vs.ctrl ~ duration, type = "response")


# E2

model <- glm(
  cbind(dead, total - dead) ~ block + duration,
  data   = mortalityByPlot(e2),
  family = binomial(link = "logit"),
  method = brglmFit
)
# check_model(model) # fine
# sim <- simulate_residuals(model)
# testResiduals(sim)
# testZeroInflation(sim)

summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ duration, type = "response")
# emmeans(model, ~ duration, type = "response") %>% pairs(adjust = "tukey")



# Combine E1 and E2

e1_e2_mortality <- mortalityByPlot(rbind(e1, e2, fill = TRUE))

# GLM

design <- cbind(dead, total - dead) ~ experiment:block + experiment * duration
model <- glm(
  design,
  data   = e1_e2_mortality,
  family = binomial(link = "logit"),
  method = brglmFit
)
# check_model(model) # fine
# sim <- simulate_residuals(model)
# testResiduals(sim)
# testZeroInflation(sim)

summary(model)
# anova(update(model, . ~ experiment:block), model, test = "Chisq")
anova(update(model, . ~ . - experiment - experiment:duration), model, test = "Chisq") # Experiment
anova(update(model, . ~ . - duration - experiment:duration), model, test = "Chisq") # Duration
anova(update(model, . ~ . - experiment:duration), model, test = "Chisq") # Interaction

emmeans(model, trt.vs.ctrl ~ duration | experiment, type = "response")

emm <- emmeans(model, ~ duration | experiment, type = "response") |> as.data.frame()
e1_e2_mortality_emm <- setDT(emm)

```

### Experiment 3

This model would not converge

DHARMa results fine.
Some binned residuals out of bounds.

```{r tree_health_models_E3}

mortalityByPlotE3 <- function(data, timepoint = "T2") {
  data[timepoint == timepoint & !is.na(health)][
    , .(dead = sum(health == "dead"), total = .N),
    by = .(plot, block, genotype, treatment)
  ][, mortality := dead / total]
}

e3_mortality <- mortalityByPlotE3(e3)


design <- cbind(dead, total - dead) ~ genotype * treatment + (1 | block / genotype)
model <- glmer(design, data = e3_mortality, family = binomial(link = "logit"))
# check_model(model) # bad
testResiduals(model)
testDispersion(model)
summary(model)


model <- glmmTMB(design, ziformula = ~ 0 + treatment, data = e3_mortality, family = betabinomial(link = "logit"))
check_model(model)
sim <- simulate_residuals(model)
testResiduals(sim)
testZeroInflation(sim)

VarCorr(model)
summary(model)
anova(update(model, . ~ . - treatment - genotype:treatment), model, test = "Chisq")
anova(update(model, . ~ . - genotype:treatment), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment | genotype, type = "response")
emm <- emmeans(model, ~ treatment | genotype, type = "response")
pairs(emm, by = "genotype", adjust = "tukey")

e3_mortality_emm <- setDT(as.data.frame(emm))



e3_health <- copy(e3)
# setnames(e3_health, "split-plot", "splitPlot")
e3_health <- e3_health[!is.na(health)][
  ,
  health := fcase(
    health %in% healthy, "healthy",
    health == "dead", "dead"
  ) |> as.factor()
]

design <- health ~ treatment * genotype + (1 | block / splitPlot)

health_model_e3 <- glmer(
  design,
  data = e3_health,
  family = binomial(link = "logit")
)

# Look for cells with 0 counts for either 'healthy' or 'dead'
# xtabs(~ health + treatment + genotype, data = e3_health)


# Check model assumptions
check_model(health_model_e3)

# sim <- simulateResiduals(health_model_e3)
# plot(sim)
# testOverdispersion(sim)

# summary(health_model_e3)
# exp(fixef(health_model_e3)) # Odds ratios
Anova(health_model_e3, type = 3) |> print()
# ranova(health_model_e3, type = 3)
# emmeans(health_model_e3, ~ duration | experiment) |> plot()

```

### Experiment 4

```{r tree_health_models_E4, eval = FALSE}

model <- glm(
  cbind(dead, total - dead) ~ block + treatment,
  data   = mortalityByPlot(e4),
  family = binomial(link = "logit"),
  method = brglmFit
)
# check_model(model) # binned residuals out of bounds
# sim <- simulate_residuals(model)
# testResiduals(sim) # significant dispersion
# testZeroInflation(sim) # significant zero inflation

summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment, type = "response")

model <- glmmTMB(
  cbind(dead, total - dead) ~ block + treatment,
  data   = mortalityByPlot(e4),
  family = betabinomial(link = "logit")
)
# check_model(model) # binned residuals out of bounds
# sim <- simulate_residuals(model)
# testResiduals(sim) # significant dispersion
# testZeroInflation(sim) # significant zero inflation

summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment, type = "response")






e4_health <- e4[!is.na(health)][,
  health := fcase(
    health %in% healthy, "healthy",
    health == "dead", "dead"
  ) |> as.factor()
]

health_model_e4 <- glmer(
  health ~ treatment + (1 | block),
  data = e4_health,
  family = binomial(link = "logit")
)

# Check model assumptions
check_model(health_model_e4)

# sim <- simulateResiduals(health_model_e4)
# plot(sim)
# testOverdispersion(sim)

# summary(health_model_e4)
# exp(fixef(health_model_e4)) # Odds ratios
Anova(health_model_e4, type = 3) |> print()
# ranova(health_model_e4, type = 3)
# emmeans(health_model_e4, ~ duration | experiment) |> plot()
emm_health_e4 <- emmeans(health_model_e4, trt.vs.ctrl ~ treatment)
print(emm_health_e4)
plot(emm_health_e4)



# # Summarise health data for E1 and E2 at T2
# e1_e2_health <- rbind(e1, e2, fill = TRUE)[
#   timepoint == "T2" & !is.na(health),
#   .(healthy = sum(health %in% healthy), dead = sum(health == "dead")),
#   by = .(experiment, block, duration)
# ][, experiment := factor(experiment)]

# design <- y ~ experiment * duration + (1 | experiment / block)

# health_model <- glmmTMB(
#   update(design, cbind(healthy, dead) ~ .),
#   data = e1_e2_health,
#   family = betabinomial(link = "logit")
# )

# health_model <- glmer(
#   update(design, cbind(healthy, dead) ~ .),
#   data = e1_e2_health,
#   family = binomial(link = "probit")
# )

# # Check model assumptions
# check_model(health_model)
# check_overdispersion(health_model)

# sim <- simulateResiduals(health_model)
# plot(sim)
# testDispersion(sim)

# summary(health_model)
# Anova(health_model, type = 3) |> print()
# # ranova(health_model, type = 3)
# emmeans(health_model, ~ duration | experiment) |> plot()

```

## Mortality plots

```{r}

mortalityPlot <- function(data) {
  ggerrorplot(
    data = mortalityByPlot(data)[, mortality := dead / total],
    x = "duration",
    y = "mortality",
    add = "jitter",
    desc_stat = "mean_ci"
  )
}

mortalityPlot(e1)


# emmeans error plot

emmMortalityPlot <- function(data, x, emm, facet = NULL) {
  ggplot() +
    geom_jitter(
      data = data,
      aes(x = get(x), y = mortality),
      width = 0.3, height = 0, alpha = 0.3, size = 2
    ) +
    geom_pointrange(
      data = emm,
      aes(x = get(x), y = prob, ymin = asymp.LCL, ymax = asymp.UCL),
      fatten = 1.8, size = 1
    ) +
    facet_wrap(~ get(facet)) +
    scale_y_continuous(labels = label_percent(accuracy = 1), limits = c(0, 1)) +
    labs(
      x = "Waterlogging duration (weeks)", y = "Mortality",
      # caption = "Points: plot-level proportions; bars: model-adjusted estimates (emmeans)"
    ) +
    theme_bw()#(base_size = 12)
}

# E1 E2 combined

a <- emmMortalityPlot(e1_e2_mortality, "duration", e1_e2_mortality_emm, "experiment")
a
ggsave(filename = "mortality_E1_E2.png", path = figures_dir)


# E3

# ggboxplot(mortalityByPlotE3(e3), "treatment", "mortality", facet.by = "genotype", add = "jitter") +
#   scale_y_continuous(labels = label_percent(accuracy = 1), limits = c(0, 1))



mortalityBoxplot <- function(data, x, facet = NULL) {
  p <- ggplot() +
    geom_boxplot(
      aes(x = get(x), y = mortality), data,
      outliers = FALSE, width = 0.4
    ) +
    geom_jitter(
      aes(x = get(x), y = mortality), data,
      width = 0.3, height = 0, alpha = 0.3, size = 2
    ) +
    scale_y_continuous(labels = label_percent(accuracy = 1), limits = c(0, 1)) +
    labs(x = "Waterlogging treatment", y = "Mortality") +
    theme_bw()#(base_size = 12)
    
  if(!is.null(facet)) p <- p + facet_wrap(~ get(facet))

  p
}

b <- mortalityBoxplot(e3_mortality, "treatment", facet = "genotype")

c <- mortalityBoxplot(mortalityByPlot(e4), "treatment")

ggarrange(a, b, c, labels = c("A", "B", "C"), ncol = 1)

ggsave(filename = "mortality_combined.png", path = figures_dir, width = 14, height = 20, units = "cm")

```


## Data cleaning

Remove pots with 2 or more dead or missing trees.
Remove dead trees.
Remove E2 pot 33

```{r data_cleaning}

# Remove pots with 2 or more dead or missing trees
remove_dead_pots <- function(data) {
  pots_to_remove <- unique(data[
    health == "dead" | health == "missing", .N, by = .(pot, timepoint)
  ][N >= 2, .(pot)])

  cat(
    "Removed", nrow(pots_to_remove),
    "pots with 2 or more dead or missing trees\n\n"
  )

  data[!.(pots_to_remove), on = .(pot)]
}

cat("Experiment 1\n")
e1 <- remove_dead_pots(e1)
cat("Experiment 2\n")
e2 <- remove_dead_pots(e2)

# Remove dead trees
remove_dead_trees <- function(data) {
  trees_to_remove <- data[health == "dead" | health == "missing", tree]
  cat("Removed", length(trees_to_remove), "remaining dead or missing trees\n\n")
  data[!(tree %in% trees_to_remove), ]
}

cat("Experiment 1\n")
e1 <- remove_dead_trees(e1)
cat("Experiment 2\n")
e2 <- remove_dead_trees(e2)

# Remove dead trees
remove_dead_trees <- function(data) {
  trees_to_remove <- data[health == "dead" | health == "missing", pot]
  cat("Removed", length(trees_to_remove), "remaining dead or missing trees\n\n")
  data[!(pot %in% trees_to_remove), ]
}

cat("Experiment 3\n")
e3 <- remove_dead_trees(e3)
cat("Experiment 4\n")
e4 <- remove_dead_trees(e4)

# Remove trees which are missing at any timepoint
remove_corresponding <- function(data) {

}


# Remove E1 8 week duration
e1 <- e1[duration != 8]

# Remove E2 pot 33
e2 <- e2[pot != 33]

# Combine E1 and E2 data
e1_e2 <- rbind(e1, e2, fill = TRUE)

```

## Growth

```{r growth functions}

#' @title Summarise growth data
#'
summarise_growth <- function(data, measurement, remove_health = NULL) {
  # Check columns
  if (!all(c(
    "experiment", "timepoint", "duration", measurement
  ) %in% colnames(data))) {
    stop("Input data does not contain required columns.")
  }

  # Summarise data by measurement
  data[
    !is.na(get(measurement)) & !(health %in% remove_health),
    .(
      mean = mean(get(measurement), na.rm = TRUE),
      median = median(get(measurement), na.rm = TRUE),
      N = .N,
      sd = sd(get(measurement), na.rm = TRUE)
    ),
    by = .(experiment, timepoint, duration)
  ][, duration := factor(duration)]
}

#' @title Plot growth data
#'
plot_growth <- function(data, measurement) {
  units <- if (measurement == "diameter") {
    "mm"
  } else if (measurement == "height") {
    "cm"
  } else {
    NULL
  }
  ggline(
    data,
    x = "timepoint",
    y = "mean",
    color = "duration"
  ) +
    labs(
      title = measurement, #paste(measurement, "by Treatment"),
      x = "Timepoint",
      y = paste0(measurement, " (", units, ")")
    )
}

```

### Growth rate

```{r growth_rate}

growth_rate <- function(data, by, final = "T3") {
  # Filter data for T1 and T3 timepoints
  data_subset <- data[timepoint %in% c("T1", final)]

  # Remove height data for broken trees
  broken <- unique(data_subset[health %in% c("top_broken", "top_dead"), get(by)])
  data_subset[get(by) %in% broken, height := NA]

  # Identify factor columns
  factor_cols <- names(data)[sapply(data, is.factor)]
  factor_cols <- factor_cols[!factor_cols %in% c("timepoint", "height")]

  # Calculate growth rate for height
  height_growth <- data_subset[
    ,
    .(
      initial_height = height[timepoint == "T1"],
      final_height = height[timepoint == final]
    ),
    by = by
  ][, `:=`(
    height_absolute = final_height - initial_height,
    height_relative = (final_height - initial_height) / initial_height,
    height_relative_ln = log(final_height / initial_height)
  )]

  # Calculate growth rate for diameter
  diameter_growth <- data_subset[
    ,
    .(
      initial_diameter = diameter[timepoint == "T1"],
      final_diameter = diameter[timepoint == final]
    ),
    by = by
  ][, `:=`(
    diameter_absolute = final_diameter - initial_diameter,
    diameter_relative = (final_diameter - initial_diameter) / initial_diameter,
    diameter_relative_ln = log(final_diameter / initial_diameter)
  )]

  # Retain factor columns
  factor_data <- unique(data_subset[, .SD, .SDcols = unique(c(by, factor_cols))], by = by)

  # Merge height and diameter growth rates
  growth_data <- merge(height_growth, diameter_growth, by = by, all = TRUE)
  merge(factor_data, growth_data, by = by, all.x = TRUE)
}


e1_growth <- growth_rate(e1, "tree")
e2_growth <- growth_rate(e2, "tree")
# e1_e2_growth <- growth_rate(e1_e2, "tree")

e3_growth <- growth_rate(e3, "pot", "T2")
e4_growth <- growth_rate(e4, "pot", "T2")

```

### Growth plots

```{r growth_plots}

# E1 combined

ggarrange(
  plot_growth(summarise_growth(e1, "diameter"), "diameter"),
  plot_growth(summarise_growth(e1, "height"), "height"),
  # with = 20, height = 15, units = "cm",
  # nrow = 1, ncol = 2,
  common.legend = TRUE, legend = "bottom"
)
ggsave(filename = "E1_growth_plots.png", path = figures_dir)

# E2 combined

ggarrange(
  plot_growth(summarise_growth(e2, "diameter"), "diameter"),
  plot_growth(summarise_growth(e2, "height"), "height"),
  # with = 20, height = 15, units = "cm",
  # nrow = 1, ncol = 2,
  common.legend = TRUE, legend = "bottom"
)
ggsave(filename = "E2_growth_plots.png", path = figures_dir)

```

```{r growth plots 2}

# Growth plots 2
plotGrowthE1E2 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "duration",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
  ) + labs(
    title = metric,
    x = "Waterlogging duration (weeks)"
    # y = "ln(height2 - height1)"
  )
}

ggarrange(
  plotGrowthE1E2(e1_growth, "height_relative_ln", "height"),
  plotGrowthE1E2(e1_growth, "diameter_relative_ln", "diameter")
)
ggsave(filename = "growth_E1.png", path = figures_dir)

ggarrange(
  plotGrowthE1E2(e2_growth, "height_relative_ln", "height"),
  plotGrowthE1E2(e2_growth, "diameter_relative_ln", "diameter")
)
ggsave(filename = "growth_E2.png", path = figures_dir)


plotGrowthE3 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "treatment",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
    # facet.by = "genotype"
  ) + facet_wrap(~ genotype, ncol = 1) + labs(
    title = metric,
    x = "Waterlogging season"
    # y = "ln(height2 - height1)"
  )
}

ggarrange(
  plotGrowthE3(e3_growth, "height_relative_ln", "height"),
  plotGrowthE3(e3_growth, "diameter_relative_ln", "diameter")
  # ncol = 1
)
ggsave(filename = "growth_E3.png", path = figures_dir)


plotGrowthE4 <- function(data, y, metric) {
  ggerrorplot(
    data = data,
    x = "treatment",
    y = y,
    add = "jitter",
    desc_stat = "mean_ci",
    size = 1,
    position = position_dodge(0.5),
    add.params = list(alpha = 0.5)
  ) + labs(
    title = metric,
    x = "Waterlogging treatment"
    # y = "ln(height2 - height1)"
  )
}

plotGrowthE4(e4_growth, "diameter_relative_ln", "diameter")
ggsave(filename = "growth_E4.png", path = figures_dir)

```


### Growth slopes

```{r growth slopes}

design <- diameter ~ elapsed_years * duration + (1 + elapsed_years | tree) + (1 | block / plot / pot)
e1_diameter_slope <- lmer(design, e1)
summary(e1_diameter_slope)
# Anova(e1_diameter_slope, type = 3)
anova(e1_diameter_slope, ddf = "Kenward-Roger", type = 3)
check_model(e1_diameter_slope)
emmeans(e1_diameter_slope, trt.vs.ctrl ~ duration, var = "elapsed_years")



# E3

design <- diameter ~ elapsed_years:treatment + (elapsed_years | pot) #+ (1 | block/splitPlot)
e3_diameter_slope <- lmer(design, e3)


# Repeated measures approach
design <- diameter ~ timepoint * genotype * treatment + (1 | block / genotype) + (1 | pot)
e3_diameter_lmm <- lmer(design, e3)
summary(e3_diameter_lmm)
Anova(e3_diameter_lmm, type = 3)
check_model(e3_diameter_lmm)
emmeans(e3_diameter_lmm, trt.vs.ctrl ~ treatment | genotype)



```

### Growth covariate anova

#### Diameter

```{r diameter ancova}

#' Pivot growth
pivotGrowth <- function(data, pivot, values = c("diameter", "height")) {
  dcast(data, pivot, value.var = values)
}


# E1

pivot <- block + plot + pot + tree + duration ~ timepoint
e1_growth <- pivotGrowth(e1, pivot)

# b0 <- mean(e1_growth$diameter_T1)

# First year growth
design <- diameter_T2 ~ diameter_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e1_growth)
# check_model(model) # fine
# testResiduals(model) # fine
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
emmeans(model, trt.vs.ctrl ~ duration)
e1_dia_T2_emm <- emmeans(model, ~ duration) |> as.data.table()

# Total growth
design <- diameter_T3 ~ diameter_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e1_growth)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e1_dia_T3_emm <- emmeans(model, ~ duration) |> as.data.table()


# E2

pivot <- block + plot + pot + tree + duration ~ timepoint
e2_growth <- pivotGrowth(e2, pivot)

# First year growth
design <- diameter_T2 ~ diameter_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e2_growth)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e2_dia_T2_emm <- emmeans(model, ~ duration) |> as.data.table()


# Total growth
design <- diameter_T3 ~ diameter_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e2_growth)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e2_dia_T3_emm <- emmeans(model, ~ duration) |> as.data.table()


# E3

pivot <- block + plot + pot + genotype + treatment ~ timepoint
e3_growth <- pivotGrowth(e3, pivot)

design <- diameter_T2 ~ diameter_T1 * genotype + genotype * treatment + (1 | block / genotype / plot)
model <- lmer(design, e3_growth)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ treatment | genotype)
e3_dia_emm <- emmeans(model, ~ treatment | genotype) |> as.data.table()



# E4

pivot <- pot + block + plot + treatment ~ timepoint
e4_growth <- pivotGrowth(e4, pivot, values = "diameter")

# Covariate approach
design <- T2 ~ T1 + treatment + (1 | block / plot)
model <- lmer(design, e4_growth)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ treatment)

```

#### Height

```{r height ancova}

height_remove <- c("broken", "top_dead")

# E1

e1_height <- e1_growth[!(tree %in% unique(e1[(health %in% height_remove), tree]))]

# First year growth
design <- height_T2 ~ height_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e1_height)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e1_height_T2_emm <- emmeans(model, ~ duration) |> as.data.table()


# Total growth
design <- height_T3 ~ height_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e1_height)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e1_height_T3_emm <- emmeans(model, ~ duration) |> as.data.table()


# E2

e2_height <- e2_growth[!(tree %in% unique(e2[(health %in% height_remove), tree]))]

# First year growth
design <- height_T2 ~ height_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e2_height)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e2_height_T2_emm <- emmeans(model, ~ duration) |> as.data.table()


# Total growth
design <- height_T3 ~ height_T1 + duration + (1 | block / plot / pot)
model <- lmer(design, e2_height)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ duration)
e2_height_T3_emm <- emmeans(model, ~ duration) |> as.data.table()


# E3

e3_height <- e3_growth[!(pot %in% unique(e3[(health %in% height_remove), pot]))]

# design <- height_T2 ~ height_T1 + genotype * treatment + (1 | block / genotype / plot)
design <- height_T2 ~ height_T1 * genotype + genotype * treatment + (1 | block / genotype / plot)
model <- lmer(design, e3_height)
summary(model)
anova(model, ddf = "Kenward-Roger", type = 3)
# check_model(model) # fine
# emmeans(model, trt.vs.ctrl ~ treatment | genotype)

```

### Growth plots

```{r}

growthByPlot <- function(data, t1, t2, x) {
  data[, .(T1 = mean(get(t1)), T2 = mean(get(t2))), .(get(x), block, plot)]
}

growthByPlot(e1_growth, "diameter_T1", "diameter_T2", "duration")


growthSlopePlot <- function(data, type, x, emm, final = "T2", facet = NULL) {
  T1 <- paste0(type, "_T1")
  T2 <- paste0(type, "_", final)
  dat <- growthByPlot(data, T1, T2, x)

  levels <- unique(dat[[x]]) |> sort()

  dat <- mutate(
    dat,
    dur_idx = as.numeric(get(x)),
    x_T1    = dur_idx - 0.4,
    x_T2    = dur_idx + 0.4
  )

  emm <- emm %>% mutate(
    dur_idx = as.numeric(get(x)),
    x_T2    = dur_idx + 0.5
  )

  p <- ggplot() +
    geom_segment(
      data = dat,
      aes(x = x_T1, xend = x_T2, y = T1, yend = T2),
      size = 0.4, alpha = 0.2
    ) +
    geom_point(data = dat, aes(x = x_T1, y = T1), alpha = 0.2) +
    geom_point(data = dat, aes(x = x_T2, y = T2), alpha = 0.2) +
    geom_pointrange(
      data = emm,
      aes(x = x_T2, y = emmean, ymin = lower.CL, ymax = upper.CL),
      size = 0.5
    ) +
    scale_x_continuous(
      breaks = seq_along(0:(length(levels) - 1)),
      labels = levels,
      expand = expansion(mult = c(0.03, 0.08))
    ) +
    labs(
      x = "Waterlogging duration",
      y = "Diameter (mm)",
      # title    = "Baseline-adjusted T2 by treatment (lines show plot-level growth)",
      # subtitle = paste("EMMs evaluated at diameter_T1 =", round(b0, 1), "mm")
    ) +
    theme_bw()

  if (!is.null(facet)) {
    facet_formula <- as.formula(paste("~", facet))
    p <- p + facet_wrap(facet_formula)
  }
  p
}

# Diameter
# E1
growthSlopePlot(e1_growth, "diameter", "duration", e1_dia_T2_emm)
growthSlopePlot(e1_growth, "diameter", "duration", e1_dia_T3_emm, "T3")

# E2
growthSlopePlot(e2_growth, "diameter", "duration", e2_dia_T2_emm)
growthSlopePlot(e2_growth, "diameter", "duration", e2_dia_T3_emm, "T3")

# E3
growthSlopePlot(e3_growth, "diameter", "treatment", e3_dia_emm, facet = "genotype")


# Height
# E1
growthSlopePlot(e1_height, "height", "duration", e1_height_T2_emm)
growthSlopePlot(e1_height, "height", "duration", e1_height_T3_emm, "T3")

#E2
growthSlopePlot(e2_height, "height", "duration", e2_height_T2_emm)
growthSlopePlot(e2_height, "height", "duration", e2_height_T3_emm, "T3")

```


### Diameter

#### Experiment 1 & 2

```{r diameter E1}

# # E1 diameter plot
# plot_growth(
#   summarise_growth(e1, "diameter"),
#   "diameter"
# )

# # E2 diameter plot
# plot_growth(
#   summarise_growth(e2, "diameter"),
#   "diameter"
# )

# Models

design <- y ~ duration + (1 | block) + (1 | pot)

# E1 diameter model

e1_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e1_growth)
check_model(e1_diameter_model)
Anova(e1_diameter_model, type = 3) |> print()
emmeans(e1_diameter_model, trt.vs.ctrl ~ duration)


# E2 diameter model

e2_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e2_growth)
check_model(e2_diameter_model)
# summary(e2_diameter_model)
Anova(e2_diameter_model, type = 3) |> print()
emm_diameter_e2 <- emmeans(e2_diameter_model, trt.vs.ctrl ~ duration)
print(emm_diameter_e2)
plot(emm_diameter_e2)


# E1 & E2 model

# design <- y ~ experiment + duration + elapsed_years + experiment:duration + duration:elapsed_years + (1 | experiment / tree) + (1 | experiment / block)

# design <- y ~ treatment * experiment * timepoint + (1 | experiment:block) + (1 | experiment:tree) + (1 | experiment:pot)

design <- ~ experiment * duration + (1 | experiment:block) + (1 | experiment:pot)

e1_e2_diameter_model <- lmer(
  update(design, diameter_relative_ln ~ .),
  data = e1_e2_growth[duration != 8]
)

check_model(e1_e2_diameter_model)
# summary(e1_e2_diameter_model)
Anova(e1_e2_diameter_model, type = 3) |> print()
emm_diameter_e1_e2 <- emmeans(e1_e2_diameter_model, trt.vs.ctrl ~ duration | experiment | timepoint)
print(emm_diameter_e1_e2)
plot(emm_diameter_e1_e2)


# E3
design <- y ~ genotype * treatment + (1 | block / splitPlot)

e3_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e3_growth)
check_model(e3_diameter_model)
Anova(e3_diameter_model, type = 3) |> print()
emmeans(e3_diameter_model, pairwise ~ genotype) |> confint()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype) |> plot()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype)


# E4
design <- y ~ treatment + (1 | block)

e4_diameter_model <- lmer(update(design, diameter_relative_ln ~ .), data = e4_growth)
check_model(e4_diameter_model)
Anova(e4_diameter_model, type = 3) |> print()
emmeans(e4_diameter_model, trt.vs.ctrl ~ treatment)
emmeans(e4_diameter_model, trt.vs.ctrl ~ treatment) |> plot()


```

### Height

```{r height}

top_removals <- c("top_broken", "top_missing")

design <- ~ duration + (1 | block) + (1 | pot)


# E1 height model

e1_height_model <- lmer(update(design, height_relative_ln ~ .), data = e1_growth)
# Check model assumptions
check_model(e1_height_model)
# summary(e1_height_model)
Anova(e1_height_model, type = 3) |> print()
emmeans(e1_height_model, trt.vs.ctrl ~ duration)

# E2 height model

e2_height_model <- lmer(update(design, height_relative_ln ~ .), data = e2_growth)
# Check model assumptions
check_model(e2_height_model)
# summary(e2_height_model)
Anova(e2_height_model, type = 3) |> print()
emm_height <- emmeans(e2_height_model, trt.vs.ctrl ~ duration)
print(emm_height)
plot(emm_height) #, comparisons = TRUE)


# E1 & E2 model

e1_e2_height_model <- lmer(
  update(E1_E2_DESIGN, height ~ .),
  data = e1_e2[!(health %in% top_removals) & duration != 8]
)

check_model(e1_e2_height_model)
# summary(e1_e2_height_model)
Anova(e1_e2_height_model, type = 3) |> print()
emm_height_e1_e2 <- emmeans(e1_e2_height_model, trt.vs.ctrl ~ duration | experiment | timepoint)
print(emm_height_e1_e2)
plot(emm_height_e1_e2)


# E3
design <- y ~ genotype * treatment + (1 | block / splitPlot)

e3_diameter_model <- lmer(update(design, height_relative_ln ~ .), data = e3_growth)
check_model(e3_diameter_model)
Anova(e3_diameter_model, type = 3) |> print()
emmeans(e3_diameter_model, trt.vs.ctrl ~ treatment | genotype)


```

```{r extension, eval = FALSE}

# Summarise feather
e2_feather_summary <- e2[
  !is.na(feather) & !(health %in% top_removals),
  .(block, plot, duration, feather)
][, .(
  feather = mean(feather, na.rm = TRUE),
  N = .N,
  sd = sd(feather, na.rm = TRUE)
), by = .(block, plot, duration)][, duration := factor(duration)]

ggboxplot(
  e2_feather_summary,
  x = "duration",
  y = "feather",
  color = "duration",
  add = "jitter"
) +
  labs(
    title = "Extension by Treatment",
    x = "Waterlogging duration (weeks)",
    y = "Extension (cm)"
  )

# E2 extension model
e2_extension_model <- lmer(
  log(feather) ~ duration + (1 | block) + (1 | pot),
  data = e2[!(health %in% top_removals)][, duration := factor(duration)]
)

# Check model assumptions
check_model(e2_extension_model)

summary(e2_extension_model)
Anova(e2_extension_model, type = 3) |> print()
emmeans(e2_extension_model, ~ duration)

```

## Canker plots

### Experiment 1

```{r E1 canker plots}

e1_canker_summary <- e1[
  !is.na(cankers), .(block, plot, duration, cankers, inoc_points)
][
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoc_points = sum(inoc_points, na.rm = TRUE),
    N = .N
  ), by = .(block, plot, duration)
][, proportion := cankers / inoc_points]

# ggboxplot(e1_canker_summary, x = "duration", y = "proportion",
#   color = "duration", palette = "jco",
#   add = "jitter",
#   title = "Total Cankers by Treatment",
#   xlab = "Treatment", ylab = "Total Cankers"
# ) + theme(legend.position = "none")

ggerrorplot(
  data = e1_canker_summary,
  x = "duration",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci",
  size = 1,
  position = position_dodge(0.5),
  add.params = list(alpha = 0.5)
) + labs(
  title = "Experiment 1: winter waterlogging timing",
  x = "Waterlogging duration (weeks)",
  y = "Cankers per inoculation point"
)
ggsave(filename = "canker_plots_E1.png", path = figures_dir)

```

### Experiment 2

```{r E2 canker plots}

e2_canker_summary <- e2[
  !is.na(rasp_inoculations), .(
    block, plot, duration,
    rasp_cankers, rasp_inoculations
  )
][, .(
  rasp_cankers = sum(rasp_cankers, na.rm = TRUE),
  rasp_inoculations = sum(rasp_inoculations, na.rm = TRUE),
  N = .N
), by = .(block, plot, duration)][,
  proportion := rasp_cankers / rasp_inoculations
]

# ggboxplot(e2_canker_summary,
#   x = "duration", y = "proportion",
#   color = "duration", palette = "jco",
#   add = "jitter",
#   title = "Proportion of cankers by Treatment",
#   xlab = "Waterlogging duration (weeks)", ylab = "Cankers per inoculation point"
# ) + theme(legend.position = "none")

ggerrorplot(
  data = e2_canker_summary,
  x = "duration",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci",
  size = 1,
  position = position_dodge(0.5),
  add.params = list(alpha = 0.5)
) + labs(
  title = "Experiment 2: winter waterlogging duration",
  x = "Waterlogging duration (weeks)",
  y = "Cankers per inoculation point"
)
ggsave(filename = "canker_plots_E2.png", path = figures_dir)

```

### Experiment 3

```{r E3 canker plots}

e3_canker_summary <- melt(
  e3[timepoint == "T2" & (!is.na(rasp_inoculations) | !is.na(leaf_scar_inoculations)), ],
  id.vars = c("block", "plot", "treatment", "genotype"),
  variable.name = "type",
  measure = list(
    cankers = c("rasp_cankers", "leaf_scar_cankers"),
    inoculations = c("rasp_inoculations", "leaf_scar_inoculations")
  ),
)[
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoculations = sum(inoculations, na.rm = TRUE),
    N = .N
  ), by = .(plot, genotype, treatment, type)
][
  , `:=`(
    proportion = cankers / inoculations,
    type = factor(type, labels = c("rasp wound", "leaf scar"))
  )
]

ggerrorplot(
  data = e3_canker_summary,
  x = "treatment",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci", # mean and CI
  size = 0.6,
  position = position_dodge(0.5),
  ggtheme = theme_bw(),
  add.params = list(alpha = 0.3) # Set alpha for jitter points
) + facet_grid(
  type ~ genotype
) + labs(
  title = "Experiment 3: waterlogging timing and rootstock genotype",
  x = "Treatment",
  y = "Cankers per inoculation point"
)
ggsave(
  filename = "canker_plots_E3_T2.png", path = figures_dir,
  width = 15, height = 10, units = "cm"
)

```

### Experiment 4

```{r E4 canker plots}

e4_canker_summary <- melt(
  e4[timepoint == "T2" & (!is.na(rasp_inoculations) | !is.na(leaf_scar_inoculations)), ],
  id.vars = c("block", "plot", "treatment"),
  variable.name = "type",
  measure = list(
    cankers = c("rasp_cankers", "leaf_scar_cankers"),
    inoculations = c("rasp_inoculations", "leaf_scar_inoculations")
  ),
)[
  , .(
    cankers = sum(cankers, na.rm = TRUE),
    inoculations = sum(inoculations, na.rm = TRUE),
    N = .N
  ), by = .(plot, treatment, type)
][
  , `:=`(
    proportion = cankers / inoculations,
    type = factor(type, labels = c("rasp wound", "leaf scar"))
  )
]

ggerrorplot(
  data = e4_canker_summary,
  x = "treatment",
  y = "proportion",
  add = "jitter",
  desc_stat = "mean_ci", # mean and CI
  size = 0.6,
  position = position_dodge(0.5),
  ggtheme = theme_bw(),
  add.params = list(alpha = 0.3) # Set alpha for jitter points
) + facet_grid(
  ~ type
) + labs(
  title = "Experiment 4: waterlogging timing and duration",
  x = "Treatment",
  y = "Cankers per inoculation point"
)
ggsave(
  filename = "canker_plots_E4_T2.png", path = figures_dir,
  width = 18, height = 10, units = "cm"
)

```

## Canker models

### Experiment 1

```{r E1 canker models, eval = FALSE}

e1_canker_data <- e1[!is.na(inoc_cankers)] |> as.data.frame()

# E1 canker model
# design <- cbind(inoc_cankers, inoc_points - inoc_cankers) ~ duration + (1 | block) + (1 | inoculation),
design <- cbind(inoc_cankers, inoc_points - inoc_cankers) ~ duration + (1 | block / plot / pot) + (1 | inoculation)
e1_canker_model <- glmer(
  design,
  family = binomial(link = "logit"),
  data = e1_canker_data
)

# Check model assumptions
check_model(e1_canker_model)
sim <- simulateResiduals(e1_canker_model)
plot(sim)
testResiduals(sim)
testZeroInflation(sim)

summary(e1_canker_model)
Anova(e1_canker_model, type = 3)
emmeans(e1_canker_model, trt.vs.ctrl ~ duration)

```

### Experiment 2

```{r E2 canker models}

# E2 data
e2_canker <- e2[!is.na(rasp_cankers) & timepoint == "T2"]

# E2 canker model
y <- cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ x
design <- update(y, . ~ duration + (1 | block / plot / pot) + (1 | inoculation))
e2_canker_model <- glmer(design, data = e2_canker, family = binomial(link = "logit"))
d0 <- update(y, ~ (1 | block / plot / pot) + (1 | inoculation))
m0 <- glmer(d0, data = e2_canker, family = binomial(link = "logit"))

# Check model assumptions
check_model(m0)
check_model(e2_canker_model) # poor
sim <- simulateResiduals(e2_canker_model)
plot(sim) # good
testResiduals(sim) # good
testDispersion(sim) # good
testZeroInflation(sim) # good

# Summary
# summary(e2_canker_model)
# exp(fixef(e2_canker_model)) # Odds ratios
anova(m0, e2_canker_model, test = "Chisq")
anova(update(e2_canker_model, . ~ (1 | block / plot / pot) + (1 | inoculation)), e2_canker_model)
Anova(e2_canker_model, type = 3)
emmeans(e2_canker_model, trt.vs.ctrl ~ duration)

```

### Experiment 3

```{r E3 canker models}

# design <- y ~ treatment * genotype + (1 | block) + (1 | pot)

# E3 data
e3_canker <- e3[timepoint == "T2" & !is.na(rasp_cankers)]

# E3 rasp wound canker model
y <- cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ x
design <- update(y, . ~ genotype * treatment + (1 | block / genotype / plot) + (1 | inoculation_group))
e3_rasp_canker_model <- glmer(
  design, data = e3_canker, family = binomial(link = "logit")
)
testDispersion(e3_rasp_canker_model) # massively overdispersed

e3_rasp_canker_model <- glmmTMB(
  design, data = e3_canker, family = betabinomial(link = "logit")
)

# Check model assumptions
check_model(e3_rasp_canker_model) # heteroskedastic and high treatment collinearity
sim <- simulateResiduals(e3_rasp_canker_model)
plot(sim) # good
testResiduals(sim) # good
# testZeroInflation(sim) # good

# Summary
# summary(e3_rasp_canker_model)
# exp(fixef(e3_rasp_canker_model)) # Odds ratios
d0 <- update(y, . ~ genotype + (1 | block / genotype / plot) + (1 | inoculation_group))
anova(update(e3_rasp_canker_model, d0), e3_rasp_canker_model, test = "Chisq")
Anova(e3_rasp_canker_model, type = 3) |> print()
# emmeans(e3_rasp_canker_model, specs = trt.vs.ctrl ~ treatment, by = "genotype", type = "response") |> plot()

emmeans(e3_rasp_canker_model, pairwise ~ genotype, type = "response")
emmeans(e3_rasp_canker_model, pairwise ~ genotype, type = "response") |> confint()

emm_e3_rasp_canker <- emmeans(e3_rasp_canker_model, trt.vs.ctrl ~ treatment | genotype, type = "response")
print(emm_e3_rasp_canker)
plot(emm_e3_rasp_canker)



# E3 leaf scar canker model
y <- cbind(leaf_scar_cankers, leaf_scar_inoculations - leaf_scar_cankers) ~ x
design <- update(y, . ~ genotype * treatment + (1 | block / genotype / plot) + (1 | inoculation_group))
e3_ls_canker_model <- glmmTMB(
  design, data = e3_canker, family = betabinomial(link = "logit")
)

# Check model assumptions
check_model(e3_ls_canker_model) # heteroskedastic
sim <- simulateResiduals(e3_ls_canker_model)
plot(sim) # good
testResiduals(sim) # good
# testZeroInflation(sim) # good

# Summary
# summary(e3_ls_canker_model)
# exp(fixef(e3_ls_canker_model)) # Odds ratios
Anova(e3_ls_canker_model, type = 3) |> print()

# emmeans
emmeans(e3_ls_canker_model, pairwise ~ genotype, type = "response")
emmeans(e3_ls_canker_model, pairwise ~ genotype, type = "response") |> confint()
emmeans(e3_ls_canker_model, trt.vs.ctrl ~ treatment, type = "response") |> plot()

emm_e3_ls_canker <- emmeans(e3_ls_canker_model, trt.vs.ctrl ~ treatment | genotype)
print(emm_e3_ls_canker)
plot(emm_e3_ls_canker)

```

### Experiment 4

```{r E4 canker models}

# E4 rasp wound canker model
e4_canker_model <- glmer(
  cbind(rasp_cankers, rasp_inoculations - rasp_cankers) ~ treatment + (1 | block),
  family = binomial(link = "logit"),
  data = e4[!is.na(rasp_cankers)]
)

# Check model assumptions
check_model(e4_canker_model)
sim <- simulateResiduals(e4_canker_model)
plot(sim)
# testDispersion(sim)
# testZeroInflation(sim)

# Summary
# summary(e4_canker_model)
# exp(fixef(e4_canker_model)) # Odds ratios
Anova(e4_canker_model, type = 3) |> print()
emm_e4_rasp_canker <- emmeans(e4_canker_model, trt.vs.ctrl ~ treatment)
print(emm_e4_rasp_canker)
plot(emm_e4_rasp_canker)


# E4 leaf scar canker model
e4_leaf_scar_canker_model <- glmer(
  cbind(leaf_scar_cankers, leaf_scar_inoculations - leaf_scar_cankers) ~ treatment + (1 | block),
  family = binomial(link = "logit"),
  data = e4[!is.na(leaf_scar_cankers)]
)

# Check model assumptions
check_model(e4_leaf_scar_canker_model)
sim <- simulateResiduals(e4_leaf_scar_canker_model)
plot(sim)
# testDispersion(sim) # slight dispersion
# testZeroInflation(sim)

# Summary
# summary(e4_leaf_scar_canker_model)
# exp(fixef(e4_leaf_scar_canker_model)) # Odds ratios
Anova(e4_leaf_scar_canker_model, type = 3) |> print()
emm_e4_leaf_scar_canker <- emmeans(e4_leaf_scar_canker_model, trt.vs.ctrl ~ treatment, type = "response")
print(emm_e4_leaf_scar_canker)
plot(emm_e4_leaf_scar_canker)

```

## Canker models - summarise by Plot

### E1

```{r}

e1_canker <- e1[
  !is.na(inoc_cankers) & timepoint == "T2",
  .(cankers = sum(inoc_cankers), inoc = sum(inoc_points)),
  by = .(plot, block, duration)
]

# Model
design <- cbind(cankers, inoc - cankers) ~ block + duration
model <- glm(design, data = e1_canker, family = binomial(link = "logit"), method = brglmFit)

# check_model(model) # resonable but poor uniformity of residuals
# sim <- simulate_residuals(model)
# testResiduals(sim) # good
# testDispersion(sim) # good
# testZeroInflation(sim) # good

# Results
summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
# Anova(model, type = 3)
emmeans(model, trt.vs.ctrl ~ duration, type = "response")

e1_canker_emm <- setDT(as.data.frame(emmeans(model, ~ duration, type = "response")))

```

### E2

```{r}

# E2 rasp
e2_rasp_canker <- e2[
  !is.na(rasp_cankers) & !is.na(rasp_inoculations) & timepoint == "T2",
  .(cankers = sum(rasp_cankers), inoc = sum(rasp_inoculations)),
  by = .(plot, block, duration)
]

# Model
design <- cbind(cankers, inoc - cankers) ~ block + duration
model <- glm(design, data = e2_rasp_canker, family = binomial(link = "logit"), method = brglmFit)

# check_model(model) # resonable
# sim <- simulate_residuals(model)
# testResiduals(sim) # significant dispersion
# testZeroInflation(sim)

# betabinomial
design <- cbind(cankers, inoc - cankers) ~ block + duration
model <- glmmTMB(design, data = e2_rasp_canker, family = betabinomial(link = "logit"))

# check_model(model) #
# sim <- simulate_residuals(model)
# testResiduals(sim) # good
# testZeroInflation(sim) # good

# Results
anova(update(model, . ~ block), model, test = "Chisq")
Anova(model, type = 3)
emmeans(model, trt.vs.ctrl ~ duration, type = "response")

e2_canker_emm <- setDT(as.data.frame(emmeans(model, ~ duration, type = "response")))


# E2 leaf scar
e2_ls_canker <- e2[!is.na(leaf_scar_cankers) & !is.na(leaf_scar_inoculations) & timepoint == "T2"][,
  .(ls_cankers = sum(leaf_scar_cankers), ls_inoc = sum(leaf_scar_inoculations)),
  by = .(plot, block, duration)
]

```

### E3

```{r}

# E3 rasp wounds
e3_rasp_canker <- e3[
  !is.na(rasp_cankers) & !is.na(rasp_inoculations) & timepoint == "T2",
  .(cankers = sum(rasp_cankers), inoc = sum(rasp_inoculations)),
  by = .(plot, block, genotype, treatment)
]

# Binomial GLMM
design <- cbind(cankers, inoc - cankers) ~ genotype * treatment + (1 | block / genotype)
model <- glmer(design, data = e3_rasp_canker, family = binomial(link = "logit"))

# check_model(model) # reasonable
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim) # fine

# Results
summary(model)
anova(update(model, . ~ . - treatment - genotype:treatment), model, test = "Chisq")
anova(update(model, . ~ . - genotype:treatment), model, test = "Chisq")


# E3 rasp wounds
e3_ls_canker <- e3[
  !is.na(leaf_scar_cankers) & !is.na(leaf_scar_inoculations) & timepoint == "T2",
  .(cankers = sum(leaf_scar_cankers), inoc = sum(leaf_scar_inoculations)),
  by = .(plot, block, genotype, treatment)
]

# Binomial GLMM
design <- cbind(cankers, inoc - cankers) ~ genotype * treatment + (1 | block / genotype)
model <- glmer(design, data = e3_ls_canker, family = binomial(link = "logit"))

# check_model(model) # reasonable
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim) # fine

# Results
summary(model)
anova(update(model, . ~ . - treatment - genotype:treatment), model, test = "Chisq")
anova(update(model, . ~ . - genotype:treatment), model, test = "Chisq")


# Combined canker types
e3_canker <- rbind(
  e3_rasp_canker[, .(plot, block, genotype, treatment, cankers, inoc, type = "Rasp wound")],
  e3_ls_canker[, .(plot, block, genotype, treatment, cankers, inoc, type = "Leaf scar")]
)

# Binomial GLMM
design <- cbind(cankers, inoc - cankers) ~ (type + genotype) * treatment + (1 | block / genotype / plot)
model <- glmer(design, data = e3_canker, family = binomial(link = "logit"), control = glmerControl(optimizer = "bobyqa"))

# check_model(model) # reasonable, some collinearity
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim) # fine

# Results
summary(model)

# Effect of treatment
anova(update(model, . ~ . - treatment - genotype:treatment - type:treatment), model, test = "Chisq")
anova(update(model, . ~ . - genotype:treatment), model, test = "Chisq")
anova(update(model, . ~ . - type:treatment), model, test = "Chisq")
emmeans(model, ~ treatment | c(type, genotype), type = "response")

# Effect of genotype
anova(update(model, . ~ . - genotype - genotype:treatment), model, test = "Chisq")
emmeans(model, pairwise ~ genotype, type = "response")

# Effect of type
anova(update(model, . ~ . - type - type:treatment), model, test = "Chisq")
emmeans(model, revpairwise ~ type, type = "response")



e3_canker_emm <- setDT(as.data.frame(emmeans(model, ~ treatment | c(type, genotype), type = "response")))

```

### E4

```{r}

e4_rasp_canker <- e4[
  !is.na(rasp_cankers) & !is.na(rasp_inoculations) & timepoint == "T2",
  .(cankers = sum(rasp_cankers), inoc = sum(rasp_inoculations)),
  by = .(plot, block, treatment)
]

# Model
design <- cbind(cankers, inoc - cankers) ~ block + treatment
model <- glm(design, data = e4_rasp_canker, family = binomial(link = "logit"), method = brglmFit)

# check_model(model) # fine
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim)

# Results
summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment, type = "response")


# Leaf scars
e4_ls_canker <- e4[
  !is.na(leaf_scar_cankers) & !is.na(leaf_scar_inoculations) & timepoint == "T2",
  .(cankers = sum(leaf_scar_cankers), inoc = sum(leaf_scar_inoculations)),
  by = .(plot, block, treatment)
]

# Model
design <- cbind(cankers, inoc - cankers) ~ block + treatment
model <- glm(design, data = e4_ls_canker, family = binomial(link = "logit"), method = brglmFit)

# check_model(model) # fine
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim)

# Results
summary(model)
anova(update(model, . ~ block), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment, type = "response")


# Combined canker types
e4_canker <- rbind(
  e4_rasp_canker[, .(plot, block, treatment, cankers, inoc, type = "Rasp wound")],
  e4_ls_canker[, .(plot, block, treatment, cankers, inoc, type = "Leaf scar")]
)

# Binomial GLMM
design <- cbind(cankers, inoc - cankers) ~ type * treatment + (1 | block / plot)
model <- glmer(design, data = e4_canker, family = binomial(link = "logit"))#, control = glmerControl(optimizer = "bobyqa"))

# check_model(model) # reasonable, some collinearity
# sim <- simulate_residuals(model)
# testResiduals(sim) # fine
# testZeroInflation(sim) # fine

# Results
summary(model)
anova(update(model, . ~ . - treatment - type:treatment), model, test = "Chisq")
anova(update(model, . ~ . - type:treatment), model, test = "Chisq")
emmeans(model, trt.vs.ctrl ~ treatment | type, type = "response")

# Wound type
anova(update(model, . ~ . - type - type:treatment), model, test = "Chisq")
emmeans(model, revpairwise ~ type, type = "response")

e4_canker_emm <- setDT(as.data.frame(emmeans(model, ~ treatment | type, type = "response")))

```

## Canker plots

```{r}

emmCankerPlot <- function(data, x, emm, xlab, facet = NULL) {
  p <- ggplot() +
    geom_jitter(
      data = data,
      aes(x = get(x), y = cankers / inoc),
      width = 0.2, height = 0, alpha = 0.2, size = 2
    ) +
    geom_pointrange(
      data = emm,
      aes(x = get(x), y = prob, ymin = asymp.LCL, ymax = asymp.UCL),
      fatten = 1.8, size = 1
    ) +
    # facet_wrap(~ get(facet)) +
    scale_y_continuous(labels = label_percent(accuracy = 1), limits = c(0, 1)) +
    labs(
      x = xlab, y = "Canker expression",
      # caption = "Points: plot-level proportions; bars: model-adjusted estimates (emmeans)"
    ) +
    theme_bw()#base_size = 12)

  if(!is.null(facet)) {
    if(length(facet) == 1) p <- p + facet_wrap(as.formula(paste("~", facet)))
    else p <- p + facet_grid(facet)
  }
  
  p
}

a <- emmCankerPlot(e1_canker, "duration", e1_canker_emm, "Waterlogging duration (weeks)") +
  theme(plot.margin = margin(t = 10, r = 5, b = 5, l = 5, unit = "pt"))
b <- emmCankerPlot(e2_rasp_canker, "duration", e2_canker_emm, "Waterlogging duration (weeks)") +
  theme(plot.margin = margin(t = 10, r = 5, b = 5, l = 5, unit = "pt"))
c <- emmCankerPlot(e3_canker, "treatment", e3_canker_emm, "Waterlogging treatment", facet = c("genotype", "type"))
d <- emmCankerPlot(e4_canker, "treatment", e4_canker_emm, "Waterlogging treatment", facet = "type") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1))

ggarrange(
  ggarrange(a, b, labels = c("A", "B"), vjust = 0.9),
  c, d,
  labels = c("", "C", "D"), vjust = 0.8,
  nrow = 3, ncol = 1, heights = c(1, 2, 1)#, align = "hv"
)
ggsave(filename = "canker_combined.png", path = figures_dir, width = 14, height = 20, units = "cm")

```
